<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Core utility functions for yolo and bacteria images with bounding boxes.">

<title>core – pilus_project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fe8f458f31a467b51aeabd2275c1e88a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="core – pilus_project">
<meta property="og:description" content="Core utility functions for yolo and bacteria images with bounding boxes.">
<meta property="og:image" content="https://galopyz.github.io/pilus_project/00_core_files/figure-html/cell-5-output-1.png">
<meta property="og:site_name" content="pilus_project">
<meta property="og:image:height" content="389">
<meta property="og:image:width" content="389">
<meta name="twitter:title" content="core – pilus_project">
<meta name="twitter:description" content="Core utility functions for yolo and bacteria images with bounding boxes.">
<meta name="twitter:image" content="https://galopyz.github.io/pilus_project/00_core_files/figure-html/cell-5-output-1.png">
<meta name="twitter:image-height" content="389">
<meta name="twitter:image-width" content="389">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">pilus_project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">core</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">pilus_project</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./train.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">train</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./darknet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Darknet</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pascal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pascal Darknet Classification</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pascal Darknet Detection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./yolov1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Yolo v1</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./yolov1_miniai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Yolo v1 using minai</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./yolov1_miniai_bac.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Yolo v1 on bacteria</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#image-processing" id="toc-image-processing" class="nav-link active" data-scroll-target="#image-processing">Image processing</a>
  <ul class="collapse">
  <li><a href="#bacteria-image" id="toc-bacteria-image" class="nav-link" data-scroll-target="#bacteria-image">Bacteria image</a></li>
  <li><a href="#calc_corners" id="toc-calc_corners" class="nav-link" data-scroll-target="#calc_corners">calc_corners</a></li>
  <li><a href="#show_bac_img_with_boxes" id="toc-show_bac_img_with_boxes" class="nav-link" data-scroll-target="#show_bac_img_with_boxes">show_bac_img_with_boxes</a></li>
  <li><a href="#voc-image" id="toc-voc-image" class="nav-link" data-scroll-target="#voc-image">VOC image</a></li>
  <li><a href="#yolo-utils" id="toc-yolo-utils" class="nav-link" data-scroll-target="#yolo-utils">yolo utils</a></li>
  <li><a href="#notes-to-myself" id="toc-notes-to-myself" class="nav-link" data-scroll-target="#notes-to-myself">Notes to myself</a></li>
  <li><a href="#other-utils" id="toc-other-utils" class="nav-link" data-scroll-target="#other-utils">other utils</a></li>
  </ul></li>
  <li><a href="#model-architecture" id="toc-model-architecture" class="nav-link" data-scroll-target="#model-architecture">Model Architecture</a>
  <ul class="collapse">
  <li><a href="#cnnblock" id="toc-cnnblock" class="nav-link" data-scroll-target="#cnnblock">CNNBlock</a></li>
  <li><a href="#yolov1" id="toc-yolov1" class="nav-link" data-scroll-target="#yolov1">Yolov1</a></li>
  </ul></li>
  <li><a href="#loss-function" id="toc-loss-function" class="nav-link" data-scroll-target="#loss-function">Loss function</a>
  <ul class="collapse">
  <li><a href="#yololoss" id="toc-yololoss" class="nav-link" data-scroll-target="#yololoss">YoloLoss</a></li>
  </ul></li>
  <li><a href="#dataset-and-dataloader" id="toc-dataset-and-dataloader" class="nav-link" data-scroll-target="#dataset-and-dataloader">DataSet and DataLoader</a></li>
  <li><a href="#learner" id="toc-learner" class="nav-link" data-scroll-target="#learner">Learner</a></li>
  <li><a href="#bacteria-images" id="toc-bacteria-images" class="nav-link" data-scroll-target="#bacteria-images">Bacteria images</a></li>
  <li><a href="#image-transform" id="toc-image-transform" class="nav-link" data-scroll-target="#image-transform">Image transform</a>
  <ul class="collapse">
  <li><a href="#clahe" id="toc-clahe" class="nav-link" data-scroll-target="#clahe">CLAHE</a></li>
  <li><a href="#apply_clahe" id="toc-apply_clahe" class="nav-link" data-scroll-target="#apply_clahe">apply_clahe</a></li>
  <li><a href="#compare_ims" id="toc-compare_ims" class="nav-link" data-scroll-target="#compare_ims">compare_ims</a></li>
  <li><a href="#compare_ims_with_boxes" id="toc-compare_ims_with_boxes" class="nav-link" data-scroll-target="#compare_ims_with_boxes">compare_ims_with_boxes</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/galopyz/pilus_project/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">core</h1>
</div>

<div>
  <div class="description">
    Core utility functions for yolo and bacteria images with bounding boxes.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>TODO:</p>
<ul class="task-list">
<li><label><input type="checkbox" checked="">Integrate yolo with minai.</label></li>
<li><label><input type="checkbox" checked="">Train yolo on VOC data. (0.1 - 0.2 mAP)</label></li>
<li><label><input type="checkbox">Combine yolo and bac notebooks. (easier to maintain)</label></li>
<li><label><input type="checkbox">Fine-tune on bac data.</label>
<ul class="task-list">
<li><label><input type="checkbox">Convert oriented bounding box format into yolo box format.</label></li>
<li><label><input type="checkbox">Might need to increase <code>S</code>, split.</label></li>
<li><label><input type="checkbox">Might need to split images into smaller images.</label></li>
<li><label><input type="checkbox">Might need a bigger model with Resnet. (How fast should predictions be?)</label></li>
</ul></li>
<li><label><input type="checkbox">Pretrain on imagenet. (yolo authors trained classifier for 1 week before box predictions)</label></li>
<li><label><input type="checkbox">Setup logging with weights and bias. (Logging loss, mAP, hyperparameters, etc.)</label></li>
<li><label><input type="checkbox">Use <code>fasttransform</code> for data augmentation. (support for encode + decode)</label></li>
<li><label><input type="checkbox">Add total time spent training.</label></li>
</ul>
<section id="image-processing" class="level2">
<h2 class="anchored" data-anchor-id="image-processing">Image processing</h2>
<section id="bacteria-image" class="level3">
<h3 class="anchored" data-anchor-id="bacteria-image">Bacteria image</h3>
<p>We have videos of bacteria. However, let’s work with images with bounding boxes first. We save first frame as images. Something was wrong with <code>20mins021.nd2</code> file, so we won’t use it.</p>
<div id="cell-7" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>video_path <span class="op">=</span> Path.home()<span class="op">/</span><span class="st">'data/pili/training_videos'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>video_path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>(#9) [Path('/home/kappa/data/pili/training_videos/200ms-0.4%-005.nd2'),Path('/home/kappa/data/pili/training_videos/0N01002.nd2'),Path('/home/kappa/data/pili/training_videos/7.1- 003.nd2'),Path('/home/kappa/data/pili/training_videos/0.1%.004.nd2'),Path('/home/kappa/data/pili/training_videos/1hr01002.nd2'),Path('/home/kappa/data/pili/training_videos/dCpdA R1 FH 017.nd2'),Path('/home/kappa/data/pili/training_videos/4hrs incu004.nd2'),Path('/home/kappa/data/pili/training_videos/WT-A86C-LB-ice-002.nd2'),Path('/home/kappa/data/pili/training_videos/Chp B Replicate 2 200 MS060.nd2')]</code></pre>
</div>
</div>
<p>Let’s take a look at an image of the first video.</p>
<div id="cell-9" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>vp <span class="op">=</span> video_path.ls()[<span class="dv">0</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>vp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Path('/home/kappa/data/pili/training_videos/200ms-0.4%-005.nd2')</code></pre>
</div>
</div>
<p>For each video, we want to only use the first frame for now. This is what it looks like:</p>
<div id="cell-11" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> nd2.ND2File(vp) <span class="im">as</span> nd2_file:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    first_frame <span class="op">=</span> nd2_file.read_frame(<span class="dv">0</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    plt.imshow(first_frame)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we turn the video into an image.</p>
<div id="cell-13" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_first_frame(input_path, output_path, extension <span class="op">=</span> <span class="st">'.png'</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Save the first frame of an ND2 file as an image, using the same name as input file.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> input_path.name.removesuffix(<span class="st">'.nd2'</span>)  <span class="co"># Some names have . in the filename</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> (output_path<span class="op">/</span><span class="ss">f'</span><span class="sc">{</span>filename<span class="sc">}{</span>extension<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    Image.fromarray(nd2.imread(input_path)[<span class="dv">0</span>]).save(output_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save videos as images</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for p in video_path.ls(): </span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     if p.suffix == '.nd2': save_first_frame(p, path)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-15" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path.home()<span class="op">/</span><span class="st">'data/pili/training_data'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>(#18) [Path('/home/kappa/data/pili/training_data/WT-A86C-LB-ice-002.png'),Path('/home/kappa/data/pili/training_data/200ms-0.4%-005.png'),Path('/home/kappa/data/pili/training_data/1hr01002.csv'),Path('/home/kappa/data/pili/training_data/dCpdA R1 FH 017.png'),Path('/home/kappa/data/pili/training_data/Chp B Replicate 2 200 MS060.png'),Path('/home/kappa/data/pili/training_data/4hrs incu004.csv'),Path('/home/kappa/data/pili/training_data/7.1- 003.png'),Path('/home/kappa/data/pili/training_data/4hrs incu004.png'),Path('/home/kappa/data/pili/training_data/200ms-0.4%-005.csv'),Path('/home/kappa/data/pili/training_data/WT-A86C-LB-ice-002.csv'),Path('/home/kappa/data/pili/training_data/0.1%.004.png'),Path('/home/kappa/data/pili/training_data/dCpdA R1 FH 017.csv'),Path('/home/kappa/data/pili/training_data/0N01002.csv'),Path('/home/kappa/data/pili/training_data/0N01002.png'),Path('/home/kappa/data/pili/training_data/Chp B Replicate 2 200 MS060.csv'),Path('/home/kappa/data/pili/training_data/7.1- 003.csv'),Path('/home/kappa/data/pili/training_data/1hr01002.png'),Path('/home/kappa/data/pili/training_data/0.1%.004.csv')]</code></pre>
</div>
</div>
<p>We can now use <code>show_image</code> to display images.</p>
<div id="cell-17" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>img_path <span class="op">=</span> path<span class="op">/</span><span class="st">'0N01002.png'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>bac_im <span class="op">=</span> np.array(Image.<span class="bu">open</span>(img_path))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>show_image(bac_im, figsize<span class="op">=</span>(<span class="dv">4</span>,<span class="dv">4</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now, we want to take care of bounding boxes. We first turn them into YOLO bounding box format because they are in angle format.</p>
<p>YOLO bounding box format:</p>
<pre><code>'class_index', 'x1', 'y1', 'x2', 'y2', 'x3', 'y3', 'x4', 'y4'</code></pre>
<p>where <code>x1</code>, …, <code>y4</code> are edge points for each box.</p>
<p>csv files have information about the box. <code>Length</code>, <code>Width</code>, <code>Position X</code> and <code>Position Y</code> are in nanometer(?).</p>
<div id="cell-20" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">'0N01002.csv'</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Length</th>
<th data-quarto-table-cell-role="th">Width</th>
<th data-quarto-table-cell-role="th">Angle</th>
<th data-quarto-table-cell-role="th">Position X</th>
<th data-quarto-table-cell-role="th">Position Y</th>
<th data-quarto-table-cell-role="th">Color R</th>
<th data-quarto-table-cell-role="th">Color G</th>
<th data-quarto-table-cell-role="th">Color B</th>
<th data-quarto-table-cell-role="th">Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Box 1</td>
<td>2.100000e-06</td>
<td>0.000001</td>
<td>0.733038</td>
<td>0.000011</td>
<td>0.000082</td>
<td>0.509804</td>
<td>0.901961</td>
<td>0.509804</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Box 2</td>
<td>2.300000e-06</td>
<td>0.000001</td>
<td>0.401426</td>
<td>0.000015</td>
<td>0.000083</td>
<td>0.509804</td>
<td>0.901961</td>
<td>0.509804</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Box 3</td>
<td>2.000000e-06</td>
<td>0.000001</td>
<td>0.837758</td>
<td>0.000013</td>
<td>0.000072</td>
<td>0.509804</td>
<td>0.901961</td>
<td>0.509804</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Box 4</td>
<td>2.100000e-06</td>
<td>0.000001</td>
<td>1.832596</td>
<td>0.000029</td>
<td>0.000075</td>
<td>0.509804</td>
<td>0.901961</td>
<td>0.509804</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Box 5</td>
<td>9.000000e-07</td>
<td>0.000001</td>
<td>-1.553343</td>
<td>0.000026</td>
<td>0.000084</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.549020</td>
<td>6</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>TODO: make <code>class_index</code> 0-based.</p>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/core.py#L30" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="calc_corners" class="level3">
<h3 class="anchored" data-anchor-id="calc_corners">calc_corners</h3>
<blockquote class="blockquote">
<pre><code> calc_corners (csv, max_pos=8.458666666666666e-05)</code></pre>
</blockquote>
<div id="cell-23" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bac_boxes <span class="op">=</span> calc_corners(path<span class="op">/</span><span class="st">'0N01002.csv'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>bac_boxes[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>tensor([[1.0000, 0.1295, 0.9836, 0.1110, 0.9670, 0.1205, 0.9565, 0.1390, 0.9731],
        [1.0000, 0.1901, 0.9989, 0.1651, 0.9883, 0.1706, 0.9752, 0.1957, 0.9859],
        [1.0000, 0.1547, 0.8677, 0.1389, 0.8501, 0.1494, 0.8406, 0.1652, 0.8582],
        [1.0000, 0.3313, 0.8914, 0.3377, 0.8674, 0.3514, 0.8710, 0.3450, 0.8950],
        [6.0000, 0.3144, 0.9890, 0.3142, 0.9996, 0.3000, 0.9994, 0.3002, 0.9887]],
       dtype=torch.float64)</code></pre>
</div>
</div>
<p>We want to take a look at images with bounding boxes.</p>
<pre><code>/opt/hostedtoolcache/Python/3.10.17/x64/lib/python3.10/site-packages/fastcore/docscrape.py:230: UserWarning: Unknown section Other Parameters
  else: warn(msg)
/opt/hostedtoolcache/Python/3.10.17/x64/lib/python3.10/site-packages/fastcore/docscrape.py:230: UserWarning: Unknown section See Also
  else: warn(msg)</code></pre>
<hr>
</section>
<section id="show_bac_img_with_boxes" class="level3">
<h3 class="anchored" data-anchor-id="show_bac_img_with_boxes">show_bac_img_with_boxes</h3>
<blockquote class="blockquote">
<pre><code> show_bac_img_with_boxes (im, boxes, figsize=(8, 8), title=None, ax=None,
                          legend=None, legend_loc='upper left', cmap=None,
                          norm=None, aspect=None, interpolation=None,
                          alpha=None, vmin=None, vmax=None,
                          colorizer=None, origin=None, extent=None,
                          interpolation_stage=None, filternorm=True,
                          filterrad=4.0, resample=None, url=None,
                          data=None)</code></pre>
</blockquote>
<p><em>Display image with bounding boxes for different cell types, returns fig and ax for further customization</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>im</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>boxes</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>figsize</td>
<td>tuple</td>
<td>(8, 8)</td>
<td></td>
</tr>
<tr class="even">
<td>title</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>ax</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>legend</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>legend_loc</td>
<td>str</td>
<td>upper left</td>
<td></td>
</tr>
<tr class="even">
<td>cmap</td>
<td>NoneType</td>
<td>None</td>
<td>The Colormap instance or registered colormap name used to map scalar data<br>to colors.<br><br>This parameter is ignored if <em>X</em> is RGB(A).</td>
</tr>
<tr class="odd">
<td>norm</td>
<td>NoneType</td>
<td>None</td>
<td>The normalization method used to scale scalar data to the [0, 1] range<br>before mapping to colors using <em>cmap</em>. By default, a linear scaling is<br>used, mapping the lowest value to 0 and the highest to 1.<br><br>If given, this can be one of the following:<br><br>- An instance of <code>.Normalize</code> or one of its subclasses<br> (see :ref:<code>colormapnorms</code>).<br>- A scale name, i.e.&nbsp;one of “linear”, “log”, “symlog”, “logit”, etc. For a<br> list of available scales, call <code>matplotlib.scale.get_scale_names()</code>.<br> In that case, a suitable <code>.Normalize</code> subclass is dynamically generated<br> and instantiated.<br><br>This parameter is ignored if <em>X</em> is RGB(A).</td>
</tr>
<tr class="even">
<td>aspect</td>
<td>NoneType</td>
<td>None</td>
<td>The aspect ratio of the Axes. This parameter is particularly<br>relevant for images since it determines whether data pixels are<br>square.<br><br>This parameter is a shortcut for explicitly calling<br><code>.Axes.set_aspect</code>. See there for further details.<br><br>- ‘equal’: Ensures an aspect ratio of 1. Pixels will be square<br> (unless pixel sizes are explicitly made non-square in data<br> coordinates using <em>extent</em>).<br>- ‘auto’: The Axes is kept fixed and the aspect is adjusted so<br> that the data fit in the Axes. In general, this will result in<br> non-square pixels.<br><br>Normally, None (the default) means to use :rc:<code>image.aspect</code>. However, if<br>the image uses a transform that does not contain the axes data transform,<br>then None means to not modify the axes aspect at all (in that case, directly<br>call <code>.Axes.set_aspect</code> if desired).</td>
</tr>
<tr class="odd">
<td>interpolation</td>
<td>NoneType</td>
<td>None</td>
<td>The interpolation method used.<br><br>Supported values are ‘none’, ‘auto’, ‘nearest’, ‘bilinear’,<br>‘bicubic’, ‘spline16’, ‘spline36’, ‘hanning’, ‘hamming’, ‘hermite’,<br>‘kaiser’, ‘quadric’, ‘catrom’, ‘gaussian’, ‘bessel’, ‘mitchell’,<br>‘sinc’, ‘lanczos’, ‘blackman’.<br><br>The data <em>X</em> is resampled to the pixel size of the image on the<br>figure canvas, using the interpolation method to either up- or<br>downsample the data.<br><br>If <em>interpolation</em> is ‘none’, then for the ps, pdf, and svg<br>backends no down- or upsampling occurs, and the image data is<br>passed to the backend as a native image. Note that different ps,<br>pdf, and svg viewers may display these raw pixels differently. On<br>other backends, ‘none’ is the same as ‘nearest’.<br><br>If <em>interpolation</em> is the default ‘auto’, then ‘nearest’<br>interpolation is used if the image is upsampled by more than a<br>factor of three (i.e.&nbsp;the number of display pixels is at least<br>three times the size of the data array). If the upsampling rate is<br>smaller than 3, or the image is downsampled, then ‘hanning’<br>interpolation is used to act as an anti-aliasing filter, unless the<br>image happens to be upsampled by exactly a factor of two or one.<br><br>See<br>:doc:<code>/gallery/images_contours_and_fields/interpolation_methods</code><br>for an overview of the supported interpolation methods, and<br>:doc:<code>/gallery/images_contours_and_fields/image_antialiasing</code> for<br>a discussion of image antialiasing.<br><br>Some interpolation methods require an additional radius parameter,<br>which can be set by <em>filterrad</em>. Additionally, the antigrain image<br>resize filter is controlled by the parameter <em>filternorm</em>.</td>
</tr>
<tr class="even">
<td>alpha</td>
<td>NoneType</td>
<td>None</td>
<td>The alpha blending value, between 0 (transparent) and 1 (opaque).<br>If <em>alpha</em> is an array, the alpha blending values are applied pixel<br>by pixel, and <em>alpha</em> must have the same shape as <em>X</em>.</td>
</tr>
<tr class="odd">
<td>vmin</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>vmax</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>colorizer</td>
<td>NoneType</td>
<td>None</td>
<td>The Colorizer object used to map color to data. If None, a Colorizer<br>object is created from a <em>norm</em> and <em>cmap</em>.<br><br>This parameter is ignored if <em>X</em> is RGB(A).</td>
</tr>
<tr class="even">
<td>origin</td>
<td>NoneType</td>
<td>None</td>
<td>Place the [0, 0] index of the array in the upper left or lower<br>left corner of the Axes. The convention (the default) ‘upper’ is<br>typically used for matrices and images.<br><br>Note that the vertical axis points upward for ‘lower’<br>but downward for ‘upper’.<br><br>See the :ref:<code>imshow_extent</code> tutorial for<br>examples and a more detailed description.</td>
</tr>
<tr class="odd">
<td>extent</td>
<td>NoneType</td>
<td>None</td>
<td>The bounding box in data coordinates that the image will fill.<br>These values may be unitful and match the units of the Axes.<br>The image is stretched individually along x and y to fill the box.<br><br>The default extent is determined by the following conditions.<br>Pixels have unit size in data coordinates. Their centers are on<br>integer coordinates, and their center coordinates range from 0 to<br>columns-1 horizontally and from 0 to rows-1 vertically.<br><br>Note that the direction of the vertical axis and thus the default<br>values for top and bottom depend on <em>origin</em>:<br><br>- For <code>origin == 'upper'</code> the default is<br> <code>(-0.5, numcols-0.5, numrows-0.5, -0.5)</code>.<br>- For <code>origin == 'lower'</code> the default is<br> <code>(-0.5, numcols-0.5, -0.5, numrows-0.5)</code>.<br><br>See the :ref:<code>imshow_extent</code> tutorial for<br>examples and a more detailed description.</td>
</tr>
<tr class="even">
<td>interpolation_stage</td>
<td>NoneType</td>
<td>None</td>
<td>Supported values:<br><br>- ‘data’: Interpolation is carried out on the data provided by the user<br> This is useful if interpolating between pixels during upsampling.<br>- ‘rgba’: The interpolation is carried out in RGBA-space after the<br> color-mapping has been applied. This is useful if downsampling and<br> combining pixels visually.<br>- ‘auto’: Select a suitable interpolation stage automatically. This uses<br> ‘rgba’ when downsampling, or upsampling at a rate less than 3, and<br> ‘data’ when upsampling at a higher rate.<br><br>See :doc:<code>/gallery/images_contours_and_fields/image_antialiasing</code> for<br>a discussion of image antialiasing.</td>
</tr>
<tr class="odd">
<td>filternorm</td>
<td>bool</td>
<td>True</td>
<td>A parameter for the antigrain image resize filter (see the<br>antigrain documentation). If <em>filternorm</em> is set, the filter<br>normalizes integer values and corrects the rounding errors. It<br>doesn’t do anything with the source floating point values, it<br>corrects only integers according to the rule of 1.0 which means<br>that any sum of pixel weights must be equal to 1.0. So, the<br>filter function must produce a graph of the proper shape.</td>
</tr>
<tr class="even">
<td>filterrad</td>
<td>float</td>
<td>4.0</td>
<td>The filter radius for filters that have a radius parameter, i.e.<br>when interpolation is one of: ‘sinc’, ‘lanczos’ or ‘blackman’.</td>
</tr>
<tr class="odd">
<td>resample</td>
<td>NoneType</td>
<td>None</td>
<td>When <em>True</em>, use a full resampling method. When <em>False</em>, only<br>resample when the output image is larger than the input image.</td>
</tr>
<tr class="even">
<td>url</td>
<td>NoneType</td>
<td>None</td>
<td>Set the url of the created <code>.AxesImage</code>. See <code>.Artist.set_url</code>.</td>
</tr>
<tr class="odd">
<td>data</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
</tbody>
</table>
<div id="cell-26" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>show_bac_img_with_boxes(bac_im, bac_boxes, legend<span class="op">=</span><span class="va">True</span>, legend_loc<span class="op">=</span><span class="st">'best'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We want to train with yolov1, which has the <code>['class_index', 'x_mid', 'y_mid', 'w', 'h']</code>. So we change the format of our coordinates.</p>
<div id="cell-28" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_yolo_boxes(csv, max_pos<span class="op">=</span><span class="fl">8.458666666666666e-05</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(csv)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        length, width, angle <span class="op">=</span> row[<span class="st">'Length'</span>], row[<span class="st">'Width'</span>], row[<span class="st">'Angle'</span>]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        pos_x, pos_y <span class="op">=</span> row[<span class="st">'Position X'</span>], row[<span class="st">'Position Y'</span>]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> pos_x <span class="op">+</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle) <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        y1 <span class="op">=</span> pos_y <span class="op">+</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle) <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> pos_x <span class="op">-</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle) <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        y2 <span class="op">=</span> pos_y <span class="op">-</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle) <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        x3 <span class="op">=</span> pos_x <span class="op">-</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle) <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        y3 <span class="op">=</span> pos_y <span class="op">-</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle) <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        x4 <span class="op">=</span> pos_x <span class="op">+</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle) <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        y4 <span class="op">=</span> pos_y <span class="op">+</span> length<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.sin(angle) <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span> <span class="op">*</span> np.cos(angle)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        x_coords, y_coords <span class="op">=</span> [x1, x2, x3, x4], [y1, y2, y3, y4]</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        x_center, y_center <span class="op">=</span> <span class="bu">sum</span>(x_coords) <span class="op">/</span> <span class="dv">4</span>, <span class="bu">sum</span>(y_coords) <span class="op">/</span> <span class="dv">4</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        bbox_width, bbox_height <span class="op">=</span> <span class="bu">max</span>(x_coords) <span class="op">-</span> <span class="bu">min</span>(x_coords), <span class="bu">max</span>(y_coords) <span class="op">-</span> <span class="bu">min</span>(y_coords)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        results.append([row[<span class="st">'Type'</span>], x_center <span class="op">/</span> max_pos, y_center <span class="op">/</span> max_pos, bbox_width <span class="op">/</span> max_pos, bbox_height <span class="op">/</span> max_pos])</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-29" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>yolo_bac_boxes <span class="op">=</span> calc_yolo_boxes(path<span class="op">/</span><span class="st">'0N01002.csv'</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>yolo_bac_boxes[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>tensor([[1.0000, 0.1250, 0.9701, 0.0279, 0.0272],
        [1.0000, 0.1804, 0.9871, 0.0306, 0.0237],
        [1.0000, 0.1521, 0.8542, 0.0264, 0.0271],
        [1.0000, 0.3414, 0.8812, 0.0201, 0.0277],
        [6.0000, 0.3072, 0.9942, 0.0144, 0.0109]], dtype=torch.float64)</code></pre>
</div>
</div>
<p>We can use <code>show_image_with_boxes</code> to show an image with boxes. Whether it is bacteria image or VOC image.</p>
<div id="cell-31" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>VOC_CLASSES <span class="op">=</span> [<span class="st">"aeroplane"</span>, <span class="st">"bicycle"</span>, <span class="st">"bird"</span>, <span class="st">"boat"</span>, <span class="st">"bottle"</span>, <span class="st">"bus"</span>, <span class="st">"car"</span>, </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>           <span class="st">"cat"</span>, <span class="st">"chair"</span>, <span class="st">"cow"</span>, <span class="st">"diningtable"</span>, <span class="st">"dog"</span>, <span class="st">"horse"</span>, <span class="st">"motorbike"</span>, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>           <span class="st">"person"</span>, <span class="st">"pottedplant"</span>, <span class="st">"sheep"</span>, <span class="st">"sofa"</span>, <span class="st">"train"</span>, <span class="st">"tvmonitor"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">@fc.delegates</span>(show_image)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_image_with_boxes(im, boxes, ax<span class="op">=</span><span class="va">None</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>), box_color<span class="op">=</span><span class="st">'red'</span>, thickness<span class="op">=</span><span class="dv">1</span>, <span class="op">**</span>kwargs):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Show image with bounding boxes with `[class_id, x_center, y_center, width, height]` format."</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> show_image(im, ax<span class="op">=</span>ax, figsize<span class="op">=</span>figsize, <span class="op">**</span>kwargs)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(im, (PIL.JpegImagePlugin.JpegImageFile, PIL.PngImagePlugin.PngImageFile)):  <span class="co"># PIL.Image</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        h, w <span class="op">=</span> im.height, im.width</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">len</span>(im.shape) <span class="op">==</span> <span class="dv">2</span>:                               <span class="co"># Bac image w/o channel</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        h, w <span class="op">=</span> im.shape</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:                                                  <span class="co"># VOC image</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        h, w <span class="op">=</span> im.shape[<span class="dv">1</span>:]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box <span class="kw">in</span> boxes:</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        class_id, x_center, y_center, width, height <span class="op">=</span> box</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        x1, y1 <span class="op">=</span> <span class="bu">int</span>((x_center <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> w), <span class="bu">int</span>((y_center <span class="op">-</span> height<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> h)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        x2, y2 <span class="op">=</span> <span class="bu">int</span>((x_center <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> w), <span class="bu">int</span>((y_center <span class="op">+</span> height<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> h)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        rect <span class="op">=</span> patches.Rectangle((x1, y1), x2<span class="op">-</span>x1, y2<span class="op">-</span>y1, linewidth<span class="op">=</span>thickness, edgecolor<span class="op">=</span>box_color, facecolor<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        ax.add_patch(rect)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        ax.text(x1, y1<span class="op">-</span><span class="dv">5</span>, <span class="ss">f"</span><span class="sc">{</span>VOC_CLASSES[<span class="bu">int</span>(class_id)]<span class="sc">}</span><span class="ss">"</span>, color<span class="op">=</span>box_color)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>TODO: Classes need to be changed for bac images.</p>
<div id="cell-34" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(bac_im, yolo_bac_boxes, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="voc-image" class="level3">
<h3 class="anchored" data-anchor-id="voc-image">VOC image</h3>
<p>We will also work with <a href="http://host.robots.ox.ac.uk/pascal/VOC/index.html">PASCAL VOC dataset</a>. VOC dataset has images and bounding boxes for corresponding objects. We can train our model on this dataset before training on bacteria dataset as we don’t have too many samples for bacteria images.</p>
<div id="cell-37" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>voc_img_path <span class="op">=</span> Path(<span class="st">'../data/images'</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>voc_img_path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>Path('../data/images')</code></pre>
</div>
</div>
<p>csv file has img and label.</p>
<div id="cell-39" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"../8examples.csv"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">img</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>000007.jpg</td>
<td>000007.txt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>000009.jpg</td>
<td>000009.txt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>000016.jpg</td>
<td>000016.txt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>000019.jpg</td>
<td>000019.txt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>000020.jpg</td>
<td>000020.txt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>000021.jpg</td>
<td>000021.txt</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>000122.jpg</td>
<td>000122.txt</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>000129.jpg</td>
<td>000129.txt</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df.iloc[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>img      000019.jpg
label    000019.txt
Name: 3, dtype: object</code></pre>
</div>
</div>
<p>Let’s take a look at an image of two cats chilling or dreaming on the ground. 😺🐈</p>
<div id="cell-42" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>voc_im <span class="op">=</span> Image.<span class="bu">open</span>(voc_img_path<span class="op">/</span>df.iloc[<span class="dv">3</span>,<span class="dv">0</span>])</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>voc_im</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we get get the boxes. We also call boxes as labels because they are the targets we are trying to predict.</p>
<div id="cell-44" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>voc_lbl_path <span class="op">=</span> Path(<span class="st">'../data/labels'</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>voc_lbl_path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>Path('../data/labels')</code></pre>
</div>
</div>
<p>Label file has boxes for each row. Each row has the shape of <code>['class_index', 'x_mid', 'y_mid', 'w', 'h']</code>. Those coordinates for each box are normalized from 0 to 1, which makes them great for working with different sized images. It is important to keep in mind that <code>x_mid</code> and <code>y_mid</code> start from top left corner.</p>
<div id="cell-46" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(voc_lbl_path<span class="op">/</span>df.iloc[<span class="dv">3</span>,<span class="dv">1</span>]) <span class="im">as</span> f:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label <span class="kw">in</span> f.readlines():</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7 0.712 0.45599999999999996 0.504 0.448

7 0.275 0.4933333333333333 0.51 0.3893333333333333
</code></pre>
</div>
</div>
<p>Let’s turn those into tensors.</p>
<div id="cell-48" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_boxes(label_path):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(label_path) <span class="im">as</span> f: </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> [[<span class="bu">float</span>(x) <span class="cf">if</span> <span class="st">'.'</span> <span class="kw">in</span> x <span class="cf">else</span> <span class="bu">int</span>(x) <span class="cf">for</span> x <span class="kw">in</span> line.strip().split()] <span class="cf">for</span> line <span class="kw">in</span> f]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(boxes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>voc_boxes <span class="op">=</span> get_boxes(voc_lbl_path<span class="op">/</span>df.iloc[<span class="dv">3</span>,<span class="dv">1</span>])</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>voc_boxes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>tensor([[7.0000, 0.7120, 0.4560, 0.5040, 0.4480],
        [7.0000, 0.2750, 0.4933, 0.5100, 0.3893]])</code></pre>
</div>
</div>
<p>We have 2 boxes, which have the same classes (cats) and bounding boxes.</p>
<div id="cell-51" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>voc_boxes.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>torch.Size([2, 5])</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(voc_im, voc_boxes, figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="yolo-utils" class="level3">
<h3 class="anchored" data-anchor-id="yolo-utils">yolo utils</h3>
<div id="cell-54" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> <span class="dv">123</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>torch.manual_seed(seed)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">2e-5</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>DEVICE <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">4</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>WEIGHT_DECAY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>NUM_WORKERS <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>PIN_MEMORY <span class="op">=</span> <span class="va">True</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>LOAD_MODEL <span class="op">=</span> <span class="va">False</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>LOAD_MODEL_FILE <span class="op">=</span> <span class="st">"overfit.pth.tar"</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>IMG_DIR <span class="op">=</span> <span class="st">"../data/images"</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>LABEL_DIR <span class="op">=</span> <span class="st">"../data/labels"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have some utility functions we need. Let’s get the dataset for VOC. For bounding boxes, we are converting coordinates based on each image into split cells.</p>
<div id="cell-56" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VOCDataset(Dataset):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, csv_file, img_dir, label_dir, S<span class="op">=</span><span class="dv">7</span>, B<span class="op">=</span><span class="dv">2</span>, C<span class="op">=</span><span class="dv">20</span>, transform<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.annotations, <span class="va">self</span>.img_dir <span class="op">=</span> pd.read_csv(csv_file), fc.Path(img_dir)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_dir, <span class="va">self</span>.transform <span class="op">=</span> fc.Path(label_dir), transform</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.S, <span class="va">self</span>.B, <span class="va">self</span>.C <span class="op">=</span> S, B, C</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>): <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.annotations)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, index):</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        label_path <span class="op">=</span> <span class="va">self</span>.label_dir <span class="op">/</span> <span class="va">self</span>.annotations.iloc[index, <span class="dv">1</span>]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="va">self</span>.img_dir <span class="op">/</span> <span class="va">self</span>.annotations.iloc[index, <span class="dv">0</span>]</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(img_path)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> get_boxes(label_path)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform: image, boxes <span class="op">=</span> <span class="va">self</span>.transform(image, boxes)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        label_matrix <span class="op">=</span> torch.zeros((<span class="va">self</span>.S, <span class="va">self</span>.S, <span class="va">self</span>.C <span class="op">+</span> <span class="dv">5</span> <span class="op">*</span> <span class="va">self</span>.B))</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box <span class="kw">in</span> boxes:</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>            class_label, x, y, width, height <span class="op">=</span> box</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            class_label <span class="op">=</span> <span class="bu">int</span>(class_label)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            i, j <span class="op">=</span> <span class="bu">int</span>(<span class="va">self</span>.S <span class="op">*</span> y), <span class="bu">int</span>(<span class="va">self</span>.S <span class="op">*</span> x)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            x_cell, y_cell <span class="op">=</span> <span class="va">self</span>.S <span class="op">*</span> x <span class="op">-</span> j, <span class="va">self</span>.S <span class="op">*</span> y <span class="op">-</span> i</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>            width_cell, height_cell <span class="op">=</span> width <span class="op">*</span> <span class="va">self</span>.S, height <span class="op">*</span> <span class="va">self</span>.S</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> label_matrix[i, j, <span class="dv">20</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>                label_matrix[i, j, <span class="dv">20</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>                label_matrix[i, j, <span class="dv">21</span>:<span class="dv">25</span>] <span class="op">=</span> torch.tensor([x_cell, y_cell, width_cell, height_cell])</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>                label_matrix[i, j, class_label] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, label_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-57" class="cell" data-scrolled="true" data-execution_count="220">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Compose(<span class="bu">object</span>):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, transforms):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transforms <span class="op">=</span> transforms</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, img, bboxes):</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> img.mode <span class="op">!=</span> <span class="st">'RGB'</span>: img <span class="op">=</span> img.convert(<span class="st">'RGB'</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="va">self</span>.transforms: img, bboxes <span class="op">=</span> t(img), bboxes</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img, bboxes</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> Compose([transforms.Resize((<span class="dv">448</span>, <span class="dv">448</span>)), transforms.ToTensor(),])</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> VOCDataset(</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../8examples.csv"</span>,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    transform<span class="op">=</span>transform,</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    img_dir<span class="op">=</span>IMG_DIR,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    label_dir<span class="op">=</span>LABEL_DIR,</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>x0, y0 <span class="op">=</span> train_dataset[<span class="dv">3</span>]</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>x0.shape, y0.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="220">
<pre><code>(torch.Size([3, 448, 448]), torch.Size([7, 7, 30]))</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>y0[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>tensor([[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 1.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 1.0000, 0.9250, 0.4533, 3.5700, 2.7253, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 1.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 1.0000, 0.9840, 0.1920, 3.5280, 3.1360, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
         0.0000, 0.0000, 0.0000]])</code></pre>
</div>
</div>
<p>To be able to visualize this, we have to convert it back to previous format.</p>
<div id="cell-60" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cellboxes_to_boxes(predictions, S<span class="op">=</span><span class="dv">7</span>, conf_threshold<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert YOLO predictions to list of bounding boxes for each image"</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> predictions.cpu().reshape(<span class="op">-</span><span class="dv">1</span>, S, S, <span class="dv">30</span>)  <span class="co"># (bs, S, S, 2*B + C)</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    bs <span class="op">=</span> predictions.shape[<span class="dv">0</span>]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    bboxes1, bboxes2 <span class="op">=</span> predictions[..., <span class="dv">21</span>:<span class="dv">25</span>], predictions[..., <span class="dv">26</span>:<span class="dv">30</span>]  <span class="co"># (bs, S, S, 4)</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> torch.stack([predictions[..., <span class="dv">20</span>], predictions[..., <span class="dv">25</span>]])   <span class="co"># (2, bs, S, S)</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    best_box <span class="op">=</span> scores.argmax(<span class="dv">0</span>).<span class="bu">bool</span>()</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    best_boxes <span class="op">=</span> torch.where(best_box.unsqueeze(<span class="op">-</span><span class="dv">1</span>), bboxes2, bboxes1)   <span class="co"># (bs, S, S, 4)</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    i, j <span class="op">=</span> torch.meshgrid(torch.arange(S), torch.arange(S), indexing<span class="op">=</span><span class="st">'ij'</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> torch.stack([j, i], dim<span class="op">=-</span><span class="dv">1</span>).unsqueeze(<span class="dv">0</span>).repeat(bs, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>).to(predictions.device)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> (best_boxes[..., <span class="dv">0</span>:<span class="dv">1</span>] <span class="op">+</span> grid[..., <span class="dv">0</span>:<span class="dv">1</span>]) <span class="op">/</span> S                      <span class="co"># (bs, S, S, 2)</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> (best_boxes[..., <span class="dv">1</span>:<span class="dv">2</span>] <span class="op">+</span> grid[..., <span class="dv">1</span>:<span class="dv">2</span>]) <span class="op">/</span> S                      <span class="co"># (bs, S, S, 2)</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    w_h <span class="op">=</span> best_boxes[..., <span class="dv">2</span>:<span class="dv">4</span>] <span class="op">/</span> S</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    predicted_class <span class="op">=</span> predictions[..., :<span class="dv">20</span>].argmax(<span class="op">-</span><span class="dv">1</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    best_confidence <span class="op">=</span> torch.<span class="bu">max</span>(predictions[..., <span class="dv">20</span>], predictions[..., <span class="dv">25</span>]).unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> torch.cat([predicted_class, best_confidence, x, y, w_h], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> best_confidence.squeeze(<span class="op">-</span><span class="dv">1</span>) <span class="op">&lt;</span> conf_threshold                  </span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove xy cooordinates without object</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    result[mask] <span class="op">=</span> <span class="dv">0</span>                                                     <span class="co"># (bs, S, S, 6)</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    converted_pred <span class="op">=</span> result.reshape(result.shape[<span class="dv">0</span>], S <span class="op">*</span> S, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    converted_pred[..., <span class="dv">0</span>] <span class="op">=</span> converted_pred[..., <span class="dv">0</span>].<span class="bu">long</span>()</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> converted_pred.tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-61" class="cell" data-scrolled="true" data-execution_count="38">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>cellboxes_to_boxes(y0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>[[[0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [7.0,
   1.0,
   0.2750000059604645,
   0.4933333396911621,
   0.5099999904632568,
   0.3893333375453949],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [7.0,
   1.0,
   0.7120000123977661,
   0.4560000002384186,
   0.5040000081062317,
   0.4480000138282776],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]]]</code></pre>
</div>
</div>
<div id="cell-62" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(cellboxes_to_boxes(y0)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>49</code></pre>
</div>
</div>
<div id="cell-63" class="cell" data-scrolled="true" data-execution_count="40">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>my_boxes <span class="op">=</span> cellboxes_to_boxes(y0)[<span class="dv">0</span>]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>my_boxes[:<span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>[[0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]]</code></pre>
</div>
</div>
<p><code>my_boxes</code> has a shape of <code>[class, confidence, x, y, w, h]</code>. But we don’t need confidence for showing an image. We could add that option in the future.</p>
<div id="cell-65" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>[[boxes[<span class="dv">0</span>]] <span class="op">+</span> boxes[<span class="dv">2</span>:] <span class="cf">for</span> boxes <span class="kw">in</span> my_boxes][:<span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>[[0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0]]</code></pre>
</div>
</div>
<div id="cell-66" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>[[[boxes[<span class="dv">0</span>]] <span class="op">+</span> boxes[<span class="dv">2</span>:] <span class="cf">for</span> boxes <span class="kw">in</span> my_boxes][<span class="dv">25</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>[[7.0,
  0.7120000123977661,
  0.4560000002384186,
  0.5040000081062317,
  0.4480000138282776]]</code></pre>
</div>
</div>
<div id="cell-67" class="cell" data-scrolled="true" data-execution_count="43">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>[[[boxes[<span class="dv">0</span>]] <span class="op">+</span> boxes[<span class="dv">2</span>:] <span class="cf">for</span> boxes <span class="kw">in</span> my_boxes]][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>[[0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [7.0,
  0.2750000059604645,
  0.4933333396911621,
  0.5099999904632568,
  0.3893333375453949],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [7.0,
  0.7120000123977661,
  0.4560000002384186,
  0.5040000081062317,
  0.4480000138282776],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0],
 [0.0, 0.0, 0.0, 0.0, 0.0]]</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, [[[boxes[<span class="dv">0</span>]] <span class="op">+</span> boxes[<span class="dv">2</span>:] <span class="cf">for</span> boxes <span class="kw">in</span> my_boxes]][<span class="dv">0</span>], figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-69" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, [[[boxes[<span class="dv">0</span>]] <span class="op">+</span> boxes[<span class="dv">2</span>:] <span class="cf">for</span> boxes <span class="kw">in</span> my_boxes][<span class="dv">25</span>]], figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-70" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shape_bb(bb, <span class="op">**</span>kwargs): <span class="cf">return</span> [[[boxes[<span class="dv">0</span>]] <span class="op">+</span> boxes[<span class="dv">2</span>:] <span class="cf">for</span> boxes <span class="kw">in</span> cellboxes_to_boxes(bb, <span class="op">**</span>kwargs)[<span class="dv">0</span>]]][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-71" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, shape_bb(y0), figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="notes-to-myself" class="level3">
<h3 class="anchored" data-anchor-id="notes-to-myself">Notes to myself</h3>
<div id="cell-73" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>test_preds <span class="op">=</span> y0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> test_preds.reshape(<span class="op">-</span><span class="dv">1</span>, S, S, <span class="dv">30</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> preds.shape[<span class="dv">0</span>]</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>torch.Size([1, 7, 7, 30])</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>bboxes1, bboxes2 <span class="op">=</span> preds[..., <span class="dv">21</span>:<span class="dv">25</span>], preds[..., <span class="dv">26</span>:<span class="dv">30</span>]</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>bboxes1.shape, bboxes2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(torch.Size([1, 7, 7, 4]), torch.Size([1, 7, 7, 4]))</code></pre>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>preds[..., <span class="dv">20</span>].shape, preds[..., <span class="dv">25</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>(torch.Size([1, 7, 7]), torch.Size([1, 7, 7]))</code></pre>
</div>
</div>
<div id="cell-77" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> torch.stack([preds[..., <span class="dv">20</span>], preds[..., <span class="dv">25</span>]])</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>scores.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>torch.Size([2, 1, 7, 7])</code></pre>
</div>
</div>
<div id="cell-78" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>best_box <span class="op">=</span> scores.argmax(<span class="dv">0</span>).<span class="bu">bool</span>()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>best_box.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>torch.Size([1, 7, 7])</code></pre>
</div>
</div>
<div id="cell-79" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>best_boxes <span class="op">=</span> torch.where(best_box.unsqueeze(<span class="op">-</span><span class="dv">1</span>), bboxes2, bboxes1)  <span class="co"># (bs, S, S, 4)</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>best_boxes.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>torch.Size([1, 7, 7, 4])</code></pre>
</div>
</div>
<div id="cell-80" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>i, j <span class="op">=</span> torch.meshgrid(torch.arange(S), torch.arange(S), indexing<span class="op">=</span><span class="st">'ij'</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>tensor([[0, 0, 0, 0, 0, 0, 0],
        [1, 1, 1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2, 2, 2],
        [3, 3, 3, 3, 3, 3, 3],
        [4, 4, 4, 4, 4, 4, 4],
        [5, 5, 5, 5, 5, 5, 5],
        [6, 6, 6, 6, 6, 6, 6]])</code></pre>
</div>
</div>
<div id="cell-81" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>j</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>tensor([[0, 1, 2, 3, 4, 5, 6],
        [0, 1, 2, 3, 4, 5, 6],
        [0, 1, 2, 3, 4, 5, 6],
        [0, 1, 2, 3, 4, 5, 6],
        [0, 1, 2, 3, 4, 5, 6],
        [0, 1, 2, 3, 4, 5, 6],
        [0, 1, 2, 3, 4, 5, 6]])</code></pre>
</div>
</div>
<div id="cell-82" class="cell" data-scrolled="true" data-execution_count="57">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> torch.stack([j, i], dim<span class="op">=-</span><span class="dv">1</span>).unsqueeze(<span class="dv">0</span>).repeat(bs, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>).to(preds.device)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>tensor([[[[0, 0],
          [1, 0],
          [2, 0],
          [3, 0],
          [4, 0],
          [5, 0],
          [6, 0]],

         [[0, 1],
          [1, 1],
          [2, 1],
          [3, 1],
          [4, 1],
          [5, 1],
          [6, 1]],

         [[0, 2],
          [1, 2],
          [2, 2],
          [3, 2],
          [4, 2],
          [5, 2],
          [6, 2]],

         [[0, 3],
          [1, 3],
          [2, 3],
          [3, 3],
          [4, 3],
          [5, 3],
          [6, 3]],

         [[0, 4],
          [1, 4],
          [2, 4],
          [3, 4],
          [4, 4],
          [5, 4],
          [6, 4]],

         [[0, 5],
          [1, 5],
          [2, 5],
          [3, 5],
          [4, 5],
          [5, 5],
          [6, 5]],

         [[0, 6],
          [1, 6],
          [2, 6],
          [3, 6],
          [4, 6],
          [5, 6],
          [6, 6]]]])</code></pre>
</div>
</div>
<div id="cell-83" class="cell" data-scrolled="true" data-execution_count="58">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>(best_boxes[..., :<span class="dv">2</span>] <span class="op">+</span> grid) <span class="op">/</span> S</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>tensor([[[[0.0000, 0.0000],
          [0.1429, 0.0000],
          [0.2857, 0.0000],
          [0.4286, 0.0000],
          [0.5714, 0.0000],
          [0.7143, 0.0000],
          [0.8571, 0.0000]],

         [[0.0000, 0.1429],
          [0.1429, 0.1429],
          [0.2857, 0.1429],
          [0.4286, 0.1429],
          [0.5714, 0.1429],
          [0.7143, 0.1429],
          [0.8571, 0.1429]],

         [[0.0000, 0.2857],
          [0.1429, 0.2857],
          [0.2857, 0.2857],
          [0.4286, 0.2857],
          [0.5714, 0.2857],
          [0.7143, 0.2857],
          [0.8571, 0.2857]],

         [[0.0000, 0.4286],
          [0.2750, 0.4933],
          [0.2857, 0.4286],
          [0.4286, 0.4286],
          [0.7120, 0.4560],
          [0.7143, 0.4286],
          [0.8571, 0.4286]],

         [[0.0000, 0.5714],
          [0.1429, 0.5714],
          [0.2857, 0.5714],
          [0.4286, 0.5714],
          [0.5714, 0.5714],
          [0.7143, 0.5714],
          [0.8571, 0.5714]],

         [[0.0000, 0.7143],
          [0.1429, 0.7143],
          [0.2857, 0.7143],
          [0.4286, 0.7143],
          [0.5714, 0.7143],
          [0.7143, 0.7143],
          [0.8571, 0.7143]],

         [[0.0000, 0.8571],
          [0.1429, 0.8571],
          [0.2857, 0.8571],
          [0.4286, 0.8571],
          [0.5714, 0.8571],
          [0.7143, 0.8571],
          [0.8571, 0.8571]]]])</code></pre>
</div>
</div>
<div id="cell-84" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>xy <span class="op">=</span> (best_boxes[..., :<span class="dv">2</span>] <span class="op">+</span> grid) <span class="op">/</span> S</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>xy.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>torch.Size([1, 7, 7, 2])</code></pre>
</div>
</div>
<div id="cell-85" class="cell" data-scrolled="true" data-execution_count="60">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>xy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>tensor([[[[0.0000, 0.0000],
          [0.1429, 0.0000],
          [0.2857, 0.0000],
          [0.4286, 0.0000],
          [0.5714, 0.0000],
          [0.7143, 0.0000],
          [0.8571, 0.0000]],

         [[0.0000, 0.1429],
          [0.1429, 0.1429],
          [0.2857, 0.1429],
          [0.4286, 0.1429],
          [0.5714, 0.1429],
          [0.7143, 0.1429],
          [0.8571, 0.1429]],

         [[0.0000, 0.2857],
          [0.1429, 0.2857],
          [0.2857, 0.2857],
          [0.4286, 0.2857],
          [0.5714, 0.2857],
          [0.7143, 0.2857],
          [0.8571, 0.2857]],

         [[0.0000, 0.4286],
          [0.2750, 0.4933],
          [0.2857, 0.4286],
          [0.4286, 0.4286],
          [0.7120, 0.4560],
          [0.7143, 0.4286],
          [0.8571, 0.4286]],

         [[0.0000, 0.5714],
          [0.1429, 0.5714],
          [0.2857, 0.5714],
          [0.4286, 0.5714],
          [0.5714, 0.5714],
          [0.7143, 0.5714],
          [0.8571, 0.5714]],

         [[0.0000, 0.7143],
          [0.1429, 0.7143],
          [0.2857, 0.7143],
          [0.4286, 0.7143],
          [0.5714, 0.7143],
          [0.7143, 0.7143],
          [0.8571, 0.7143]],

         [[0.0000, 0.8571],
          [0.1429, 0.8571],
          [0.2857, 0.8571],
          [0.4286, 0.8571],
          [0.5714, 0.8571],
          [0.7143, 0.8571],
          [0.8571, 0.8571]]]])</code></pre>
</div>
</div>
<div id="cell-86" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>w_h <span class="op">=</span> best_boxes[..., <span class="dv">2</span>:<span class="dv">4</span>] <span class="op">/</span> S</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>w_h.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>torch.Size([1, 7, 7, 2])</code></pre>
</div>
</div>
<div id="cell-87" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>w_h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>tensor([[[[0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000]],

         [[0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000]],

         [[0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000]],

         [[0.0000, 0.0000],
          [0.5100, 0.3893],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.5040, 0.4480],
          [0.0000, 0.0000],
          [0.0000, 0.0000]],

         [[0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000]],

         [[0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000]],

         [[0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000],
          [0.0000, 0.0000]]]])</code></pre>
</div>
</div>
<div id="cell-88" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>pred_class <span class="op">=</span> preds[..., :<span class="dv">20</span>].argmax(<span class="op">-</span><span class="dv">1</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>pred_class</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>tensor([[[[0],
          [0],
          [0],
          [0],
          [0],
          [0],
          [0]],

         [[0],
          [0],
          [0],
          [0],
          [0],
          [0],
          [0]],

         [[0],
          [0],
          [0],
          [0],
          [0],
          [0],
          [0]],

         [[0],
          [7],
          [0],
          [0],
          [7],
          [0],
          [0]],

         [[0],
          [0],
          [0],
          [0],
          [0],
          [0],
          [0]],

         [[0],
          [0],
          [0],
          [0],
          [0],
          [0],
          [0]],

         [[0],
          [0],
          [0],
          [0],
          [0],
          [0],
          [0]]]])</code></pre>
</div>
</div>
<div id="cell-89" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>best_confidence <span class="op">=</span> torch.<span class="bu">max</span>(preds[..., <span class="dv">20</span>], preds[..., <span class="dv">25</span>]).unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>best_confidence.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>torch.Size([1, 7, 7, 1])</code></pre>
</div>
</div>
<div id="cell-90" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>torch.cat([pred_class, best_confidence, xy, w_h], dim<span class="op">=-</span><span class="dv">1</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>torch.Size([1, 7, 7, 6])</code></pre>
</div>
</div>
</section>
<section id="other-utils" class="level3">
<h3 class="anchored" data-anchor-id="other-utils">other utils</h3>
<div id="cell-92" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> non_max_suppression(bboxes, iou_threshold, threshold, box_format<span class="op">=</span><span class="st">"corners"</span>):</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">type</span>(bboxes) <span class="op">==</span> <span class="bu">list</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    bboxes <span class="op">=</span> <span class="bu">sorted</span>([box <span class="cf">for</span> box <span class="kw">in</span> bboxes <span class="cf">if</span> box[<span class="dv">1</span>] <span class="op">&gt;</span> threshold], key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    bboxes_after_nms <span class="op">=</span> []</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> bboxes:</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>        chosen_box <span class="op">=</span> bboxes.pop(<span class="dv">0</span>)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>        bboxes <span class="op">=</span> [box <span class="cf">for</span> box <span class="kw">in</span> bboxes <span class="cf">if</span> box[<span class="dv">0</span>] <span class="op">!=</span> chosen_box[<span class="dv">0</span>] <span class="kw">or</span> </span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>                 intersection_over_union(torch.tensor(chosen_box[<span class="dv">2</span>:]), torch.tensor(box[<span class="dv">2</span>:]), box_format<span class="op">=</span>box_format) <span class="op">&lt;</span> iou_threshold]</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>        bboxes_after_nms.append(chosen_box)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bboxes_after_nms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-93" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> intersection_over_union(boxes_preds, boxes_labels, box_format<span class="op">=</span><span class="st">"midpoint"</span>):</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> box_format <span class="op">==</span> <span class="st">"midpoint"</span>:</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>        box1_x1, box1_y1 <span class="op">=</span> boxes_preds[..., <span class="dv">0</span>:<span class="dv">1</span>] <span class="op">-</span> boxes_preds[..., <span class="dv">2</span>:<span class="dv">3</span>] <span class="op">/</span> <span class="dv">2</span>, boxes_preds[..., <span class="dv">1</span>:<span class="dv">2</span>] <span class="op">-</span> boxes_preds[..., <span class="dv">3</span>:<span class="dv">4</span>] <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>        box1_x2, box1_y2 <span class="op">=</span> boxes_preds[..., <span class="dv">0</span>:<span class="dv">1</span>] <span class="op">+</span> boxes_preds[..., <span class="dv">2</span>:<span class="dv">3</span>] <span class="op">/</span> <span class="dv">2</span>, boxes_preds[..., <span class="dv">1</span>:<span class="dv">2</span>] <span class="op">+</span> boxes_preds[..., <span class="dv">3</span>:<span class="dv">4</span>] <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>        box2_x1, box2_y1 <span class="op">=</span> boxes_labels[..., <span class="dv">0</span>:<span class="dv">1</span>] <span class="op">-</span> boxes_labels[..., <span class="dv">2</span>:<span class="dv">3</span>] <span class="op">/</span> <span class="dv">2</span>, boxes_labels[..., <span class="dv">1</span>:<span class="dv">2</span>] <span class="op">-</span> boxes_labels[..., <span class="dv">3</span>:<span class="dv">4</span>] <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>        box2_x2, box2_y2 <span class="op">=</span> boxes_labels[..., <span class="dv">0</span>:<span class="dv">1</span>] <span class="op">+</span> boxes_labels[..., <span class="dv">2</span>:<span class="dv">3</span>] <span class="op">/</span> <span class="dv">2</span>, boxes_labels[..., <span class="dv">1</span>:<span class="dv">2</span>] <span class="op">+</span> boxes_labels[..., <span class="dv">3</span>:<span class="dv">4</span>] <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>        box1_x1, box1_y1, box1_x2, box1_y2 <span class="op">=</span> boxes_preds[..., <span class="dv">0</span>:<span class="dv">1</span>], boxes_preds[..., <span class="dv">1</span>:<span class="dv">2</span>], boxes_preds[..., <span class="dv">2</span>:<span class="dv">3</span>], boxes_preds[..., <span class="dv">3</span>:<span class="dv">4</span>]</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>        box2_x1, box2_y1, box2_x2, box2_y2 <span class="op">=</span> boxes_labels[..., <span class="dv">0</span>:<span class="dv">1</span>], boxes_labels[..., <span class="dv">1</span>:<span class="dv">2</span>], boxes_labels[..., <span class="dv">2</span>:<span class="dv">3</span>], boxes_labels[..., <span class="dv">3</span>:<span class="dv">4</span>]</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    x1, y1 <span class="op">=</span> torch.<span class="bu">max</span>(box1_x1, box2_x1), torch.<span class="bu">max</span>(box1_y1, box2_y1)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    x2, y2 <span class="op">=</span> torch.<span class="bu">min</span>(box1_x2, box2_x2), torch.<span class="bu">min</span>(box1_y2, box2_y2)</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    intersection <span class="op">=</span> (x2 <span class="op">-</span> x1).clamp(<span class="dv">0</span>) <span class="op">*</span> (y2 <span class="op">-</span> y1).clamp(<span class="dv">0</span>)</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    box1_area, box2_area <span class="op">=</span> <span class="bu">abs</span>((box1_x2 <span class="op">-</span> box1_x1) <span class="op">*</span> (box1_y2 <span class="op">-</span> box1_y1)), <span class="bu">abs</span>((box2_x2 <span class="op">-</span> box2_x1) <span class="op">*</span> (box2_y2 <span class="op">-</span> box2_y1))</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> intersection <span class="op">/</span> (box1_area <span class="op">+</span> box2_area <span class="op">-</span> intersection <span class="op">+</span> <span class="fl">1e-6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="model-architecture" class="level2">
<h2 class="anchored" data-anchor-id="model-architecture">Model Architecture</h2>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/yolov1.py#L480" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="cnnblock" class="level3">
<h3 class="anchored" data-anchor-id="cnnblock">CNNBlock</h3>
<blockquote class="blockquote">
<pre><code> CNNBlock (in_channels, out_channels, **kwargs)</code></pre>
</blockquote>
<p>*Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing them to be nested in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self) -&gt; None:
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will also have their parameters converted when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<p>:ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool*</p>
<div id="cell-96" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>CNNBlock(<span class="dv">1</span>, <span class="dv">32</span>, kernel_size<span class="op">=</span><span class="dv">1</span>, stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>CNNBlock(
  (conv): Conv2d(1, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
  (batchnorm): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (leakyrelu): LeakyReLU(negative_slope=0.1)
)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/yolov1.py#L491" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="yolov1" class="level3">
<h3 class="anchored" data-anchor-id="yolov1">Yolov1</h3>
<blockquote class="blockquote">
<pre><code> Yolov1 (in_channels=3, **kwargs)</code></pre>
</blockquote>
<p>*Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing them to be nested in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self) -&gt; None:
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will also have their parameters converted when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<p>:ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool*</p>
<div id="cell-98" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Yolov1(split_size<span class="op">=</span><span class="dv">7</span>, num_boxes<span class="op">=</span><span class="dv">2</span>, num_classes<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>Yolov1(
  (darknet): Sequential(
    (0): CNNBlock(
      (conv): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
      (batchnorm): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (1): MaxPool2d(kernel_size=(2, 2), stride=(2, 2), padding=0, dilation=1, ceil_mode=False)
    (2): CNNBlock(
      (conv): Conv2d(64, 192, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(192, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (3): MaxPool2d(kernel_size=(2, 2), stride=(2, 2), padding=0, dilation=1, ceil_mode=False)
    (4): CNNBlock(
      (conv): Conv2d(192, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (5): CNNBlock(
      (conv): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (6): CNNBlock(
      (conv): Conv2d(256, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (7): CNNBlock(
      (conv): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (8): MaxPool2d(kernel_size=(2, 2), stride=(2, 2), padding=0, dilation=1, ceil_mode=False)
    (9): CNNBlock(
      (conv): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (10): CNNBlock(
      (conv): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (11): CNNBlock(
      (conv): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (12): CNNBlock(
      (conv): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (13): CNNBlock(
      (conv): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (14): CNNBlock(
      (conv): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (15): CNNBlock(
      (conv): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (16): CNNBlock(
      (conv): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (17): CNNBlock(
      (conv): Conv2d(512, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (18): CNNBlock(
      (conv): Conv2d(512, 1024, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (19): MaxPool2d(kernel_size=(2, 2), stride=(2, 2), padding=0, dilation=1, ceil_mode=False)
    (20): CNNBlock(
      (conv): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (21): CNNBlock(
      (conv): Conv2d(512, 1024, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (22): CNNBlock(
      (conv): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (23): CNNBlock(
      (conv): Conv2d(512, 1024, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (24): CNNBlock(
      (conv): Conv2d(1024, 1024, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (25): CNNBlock(
      (conv): Conv2d(1024, 1024, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (26): CNNBlock(
      (conv): Conv2d(1024, 1024, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
    (27): CNNBlock(
      (conv): Conv2d(1024, 1024, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (batchnorm): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (leakyrelu): LeakyReLU(negative_slope=0.1)
    )
  )
  (fcs): Sequential(
    (0): Flatten(start_dim=1, end_dim=-1)
    (1): Linear(in_features=50176, out_features=496, bias=True)
    (2): Dropout(p=0.0, inplace=False)
    (3): LeakyReLU(negative_slope=0.1)
    (4): Linear(in_features=496, out_features=1470, bias=True)
  )
)</code></pre>
</div>
</div>
</section>
</section>
<section id="loss-function" class="level2">
<h2 class="anchored" data-anchor-id="loss-function">Loss function</h2>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/yolov1.py#L564" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="yololoss" class="level3">
<h3 class="anchored" data-anchor-id="yololoss">YoloLoss</h3>
<blockquote class="blockquote">
<pre><code> YoloLoss (S=7, B=2, C=20)</code></pre>
</blockquote>
<p><em>Calculate the loss for yolo (v1) model</em></p>
<div id="cell-101" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>S<span class="op">=</span><span class="dv">7</span><span class="op">;</span> B<span class="op">=</span><span class="dv">2</span><span class="op">;</span> C<span class="op">=</span><span class="dv">20</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>lambda_noobj <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>lambda_coord <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> torch.randn(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">7</span>, <span class="dv">30</span>)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> torch.randn(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">7</span>, <span class="dv">25</span>)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> predictions.reshape(<span class="op">-</span><span class="dv">1</span>, S, S, C <span class="op">+</span> B <span class="op">*</span> <span class="dv">5</span>)  <span class="co"># (bs, S, S, 30)</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>predictions.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>torch.Size([1, 7, 7, 30])</code></pre>
</div>
</div>
</section>
</section>
<section id="dataset-and-dataloader" class="level2">
<h2 class="anchored" data-anchor-id="dataset-and-dataloader">DataSet and DataLoader</h2>
<div id="cell-103" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-104" class="cell" data-scrolled="false" data-execution_count="78">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>trn_ds <span class="op">=</span> VOCDataset(<span class="st">"../8examples.csv"</span>, </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>transform,</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>                    img_dir<span class="op">=</span>IMG_DIR,</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>                    label_dir<span class="op">=</span>LABEL_DIR)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>x0, y0 <span class="op">=</span> trn_ds[<span class="dv">0</span>]</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, shape_bb(y0, conf_threshold<span class="op">=</span><span class="fl">0.4</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-72-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-105" class="cell" data-scrolled="false" data-execution_count="79">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>val_ds <span class="op">=</span> VOCDataset(<span class="st">'../8examples_val.csv'</span>, transform<span class="op">=</span>transform, img_dir<span class="op">=</span>IMG_DIR, label_dir<span class="op">=</span>LABEL_DIR)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>x0, y0 <span class="op">=</span> val_ds[<span class="dv">0</span>]</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, shape_bb(y0, conf_threshold<span class="op">=</span><span class="fl">0.4</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-73-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-106" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>trn_dl, val_dl <span class="op">=</span> get_dls(trn_ds, val_ds, bs)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(trn_dl))</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>(torch.Size([2, 3, 448, 448]), torch.Size([2, 7, 7, 30]))</code></pre>
</div>
</div>
<div id="cell-107" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataLoaders(trn_dl, val_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="learner" class="level2">
<h2 class="anchored" data-anchor-id="learner">Learner</h2>
<div id="cell-109" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MeanAP:</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_classes<span class="op">=</span><span class="dv">1</span>, epsilon<span class="op">=</span><span class="fl">1e-6</span>, threshold<span class="op">=</span><span class="fl">0.4</span>, iou_threshold<span class="op">=</span><span class="fl">0.5</span>, box_format<span class="op">=</span><span class="st">'midpoint'</span>):</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_classes <span class="op">=</span> num_classes</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.epsilon <span class="op">=</span> epsilon</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> threshold</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iou_threshold <span class="op">=</span> iou_threshold</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.box_format <span class="op">=</span> box_format</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.average_precisions <span class="op">=</span> []</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset(<span class="va">self</span>):</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.average_precisions <span class="op">=</span> []</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute(<span class="va">self</span>):</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(<span class="va">self</span>.average_precisions) <span class="op">/</span> <span class="bu">len</span>(<span class="va">self</span>.average_precisions)</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update(<span class="va">self</span>, pred, label):</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># `get_bboxes` part</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>        all_pred_boxes <span class="op">=</span> []</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>        all_true_boxes <span class="op">=</span> []</span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        train_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>        batch_size <span class="op">=</span> pred.shape[<span class="dv">0</span>]</span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>        pred_boxes <span class="op">=</span> cellboxes_to_boxes(pred)</span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>        true_boxes <span class="op">=</span> cellboxes_to_boxes(label)</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">range</span>(batch_size):</span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>            nms_boxes <span class="op">=</span> non_max_suppression(</span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>                pred_boxes[idx],</span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>                iou_threshold<span class="op">=</span><span class="va">self</span>.iou_threshold,</span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>                threshold<span class="op">=</span><span class="va">self</span>.threshold,</span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>                box_format<span class="op">=</span><span class="va">self</span>.box_format,</span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> nms_box <span class="kw">in</span> nms_boxes:</span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>                all_pred_boxes.append([train_idx] <span class="op">+</span> nms_box)</span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> box <span class="kw">in</span> true_boxes[idx]:</span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># many will get converted to 0 pred</span></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> box[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="va">self</span>.threshold:</span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>                    all_true_boxes.append([train_idx] <span class="op">+</span> box)</span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a>        pred_boxes <span class="op">=</span> all_pred_boxes</span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a>        true_boxes <span class="op">=</span> all_true_boxes</span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.num_classes):</span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>            detections <span class="op">=</span> []</span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a>            ground_truths <span class="op">=</span> []</span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Go through all predictions and targets,</span></span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># and only add the ones that belong to the</span></span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># current class c</span></span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> detection <span class="kw">in</span> pred_boxes:</span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> detection[<span class="dv">1</span>] <span class="op">==</span> c:</span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>                    detections.append(detection)</span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> true_box <span class="kw">in</span> true_boxes:</span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> true_box[<span class="dv">1</span>] <span class="op">==</span> c:</span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>                    ground_truths.append(true_box)</span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># find the amount of bboxes for each training example</span></span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Counter here finds how many ground truth bboxes we get</span></span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>            <span class="co"># for each training example, so let's say img 0 has 3,</span></span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># img 1 has 5 then we will obtain a dictionary with:</span></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># amount_bboxes = {0:3, 1:5}</span></span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a>            amount_bboxes <span class="op">=</span> Counter([gt[<span class="dv">0</span>] <span class="cf">for</span> gt <span class="kw">in</span> ground_truths])</span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We then go through each key, val in this dictionary</span></span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># and convert to the following (w.r.t same example):</span></span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ammount_bboxes = {0:torch.tensor[0,0,0], 1:torch.tensor[0,0,0,0,0]}</span></span>
<span id="cb118-69"><a href="#cb118-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> key, val <span class="kw">in</span> amount_bboxes.items():</span>
<span id="cb118-70"><a href="#cb118-70" aria-hidden="true" tabindex="-1"></a>                amount_bboxes[key] <span class="op">=</span> torch.zeros(val)</span>
<span id="cb118-71"><a href="#cb118-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-72"><a href="#cb118-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># sort by box probabilities which is index 2</span></span>
<span id="cb118-73"><a href="#cb118-73" aria-hidden="true" tabindex="-1"></a>            detections.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">2</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb118-74"><a href="#cb118-74" aria-hidden="true" tabindex="-1"></a>            TP <span class="op">=</span> torch.zeros((<span class="bu">len</span>(detections)))</span>
<span id="cb118-75"><a href="#cb118-75" aria-hidden="true" tabindex="-1"></a>            FP <span class="op">=</span> torch.zeros((<span class="bu">len</span>(detections)))</span>
<span id="cb118-76"><a href="#cb118-76" aria-hidden="true" tabindex="-1"></a>            total_true_bboxes <span class="op">=</span> <span class="bu">len</span>(ground_truths)</span>
<span id="cb118-77"><a href="#cb118-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-78"><a href="#cb118-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If none exists for this class then we can safely skip</span></span>
<span id="cb118-79"><a href="#cb118-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total_true_bboxes <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb118-80"><a href="#cb118-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb118-81"><a href="#cb118-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-82"><a href="#cb118-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> detection_idx, detection <span class="kw">in</span> <span class="bu">enumerate</span>(detections):</span>
<span id="cb118-83"><a href="#cb118-83" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only take out the ground_truths that have the same</span></span>
<span id="cb118-84"><a href="#cb118-84" aria-hidden="true" tabindex="-1"></a>                <span class="co"># training idx as detection</span></span>
<span id="cb118-85"><a href="#cb118-85" aria-hidden="true" tabindex="-1"></a>                ground_truth_img <span class="op">=</span> [</span>
<span id="cb118-86"><a href="#cb118-86" aria-hidden="true" tabindex="-1"></a>                    bbox <span class="cf">for</span> bbox <span class="kw">in</span> ground_truths <span class="cf">if</span> bbox[<span class="dv">0</span>] <span class="op">==</span> detection[<span class="dv">0</span>]</span>
<span id="cb118-87"><a href="#cb118-87" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb118-88"><a href="#cb118-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-89"><a href="#cb118-89" aria-hidden="true" tabindex="-1"></a>                num_gts <span class="op">=</span> <span class="bu">len</span>(ground_truth_img)</span>
<span id="cb118-90"><a href="#cb118-90" aria-hidden="true" tabindex="-1"></a>                best_iou <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb118-91"><a href="#cb118-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-92"><a href="#cb118-92" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> idx, gt <span class="kw">in</span> <span class="bu">enumerate</span>(ground_truth_img):</span>
<span id="cb118-93"><a href="#cb118-93" aria-hidden="true" tabindex="-1"></a>                    iou <span class="op">=</span> intersection_over_union(</span>
<span id="cb118-94"><a href="#cb118-94" aria-hidden="true" tabindex="-1"></a>                        torch.tensor(detection[<span class="dv">3</span>:]),</span>
<span id="cb118-95"><a href="#cb118-95" aria-hidden="true" tabindex="-1"></a>                        torch.tensor(gt[<span class="dv">3</span>:]),</span>
<span id="cb118-96"><a href="#cb118-96" aria-hidden="true" tabindex="-1"></a>                        box_format<span class="op">=</span><span class="va">self</span>.box_format,</span>
<span id="cb118-97"><a href="#cb118-97" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb118-98"><a href="#cb118-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-99"><a href="#cb118-99" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> iou <span class="op">&gt;</span> best_iou:</span>
<span id="cb118-100"><a href="#cb118-100" aria-hidden="true" tabindex="-1"></a>                        best_iou <span class="op">=</span> iou</span>
<span id="cb118-101"><a href="#cb118-101" aria-hidden="true" tabindex="-1"></a>                        best_gt_idx <span class="op">=</span> idx</span>
<span id="cb118-102"><a href="#cb118-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-103"><a href="#cb118-103" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> best_iou <span class="op">&gt;</span> <span class="va">self</span>.iou_threshold:</span>
<span id="cb118-104"><a href="#cb118-104" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># only detect ground truth detection once</span></span>
<span id="cb118-105"><a href="#cb118-105" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> amount_bboxes[detection[<span class="dv">0</span>]][best_gt_idx] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb118-106"><a href="#cb118-106" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># true positive and add this bounding box to seen</span></span>
<span id="cb118-107"><a href="#cb118-107" aria-hidden="true" tabindex="-1"></a>                        TP[detection_idx] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb118-108"><a href="#cb118-108" aria-hidden="true" tabindex="-1"></a>                        amount_bboxes[detection[<span class="dv">0</span>]][best_gt_idx] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb118-109"><a href="#cb118-109" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb118-110"><a href="#cb118-110" aria-hidden="true" tabindex="-1"></a>                        FP[detection_idx] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb118-111"><a href="#cb118-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-112"><a href="#cb118-112" aria-hidden="true" tabindex="-1"></a>                <span class="co"># if IOU is lower then the detection is a false positive</span></span>
<span id="cb118-113"><a href="#cb118-113" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb118-114"><a href="#cb118-114" aria-hidden="true" tabindex="-1"></a>                    FP[detection_idx] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb118-115"><a href="#cb118-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-116"><a href="#cb118-116" aria-hidden="true" tabindex="-1"></a>            TP_cumsum <span class="op">=</span> torch.cumsum(TP, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb118-117"><a href="#cb118-117" aria-hidden="true" tabindex="-1"></a>            FP_cumsum <span class="op">=</span> torch.cumsum(FP, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb118-118"><a href="#cb118-118" aria-hidden="true" tabindex="-1"></a>            recalls <span class="op">=</span> TP_cumsum <span class="op">/</span> (total_true_bboxes <span class="op">+</span> <span class="va">self</span>.epsilon)</span>
<span id="cb118-119"><a href="#cb118-119" aria-hidden="true" tabindex="-1"></a>            precisions <span class="op">=</span> torch.divide(TP_cumsum, (TP_cumsum <span class="op">+</span> FP_cumsum <span class="op">+</span> <span class="va">self</span>.epsilon))</span>
<span id="cb118-120"><a href="#cb118-120" aria-hidden="true" tabindex="-1"></a>            precisions <span class="op">=</span> torch.cat((torch.tensor([<span class="dv">1</span>]), precisions))</span>
<span id="cb118-121"><a href="#cb118-121" aria-hidden="true" tabindex="-1"></a>            recalls <span class="op">=</span> torch.cat((torch.tensor([<span class="dv">0</span>]), recalls))</span>
<span id="cb118-122"><a href="#cb118-122" aria-hidden="true" tabindex="-1"></a>            <span class="co"># torch.trapz for numerical integration</span></span>
<span id="cb118-123"><a href="#cb118-123" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.average_precisions.append(torch.trapz(precisions, recalls))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-110" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>cbs <span class="op">=</span> [</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    TrainCB(),</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    DeviceCB(),</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    MetricsCB(MeanAP(num_classes<span class="op">=</span><span class="dv">20</span>)),</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> partial(torch.optim.AdamW, betas<span class="op">=</span>(<span class="fl">0.9</span>,<span class="fl">0.95</span>), eps<span class="op">=</span><span class="fl">1e-5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-111" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Yolov1(split_size<span class="op">=</span><span class="dv">7</span>, num_boxes<span class="op">=</span><span class="dv">2</span>, num_classes<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>lr, epochs <span class="op">=</span> <span class="fl">1e-4</span>, <span class="dv">20</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>tmax <span class="op">=</span> epochs <span class="op">*</span> <span class="bu">len</span>(dls.train)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>sched <span class="op">=</span> partial(lr_scheduler.OneCycleLR, max_lr<span class="op">=</span>lr, total_steps<span class="op">=</span>tmax)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>xtra <span class="op">=</span> [BatchSchedCB(sched)]</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(model, dls, YoloLoss(), lr<span class="op">=</span>lr, cbs<span class="op">=</span>cbs<span class="op">+</span>xtra, opt_func<span class="op">=</span>torch.optim.AdamW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-112" class="cell" data-scrolled="true" data-execution_count="85">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>learn.show_image_batch(max_n<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-79-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-113" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>learn.fit(epochs, cbs<span class="op">=</span>[ProgressCB(plot<span class="op">=</span><span class="va">True</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">MeanAP</th>
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.000</td>
<td>164.220</td>
<td>0</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>211.467</td>
<td>0</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>103.889</td>
<td>1</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>200.495</td>
<td>1</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>64.096</td>
<td>2</td>
<td>train</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>182.836</td>
<td>2</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>60.757</td>
<td>3</td>
<td>train</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>172.836</td>
<td>3</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.050</td>
<td>58.652</td>
<td>4</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>169.163</td>
<td>4</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.011</td>
<td>37.878</td>
<td>5</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>167.833</td>
<td>5</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.129</td>
<td>87.072</td>
<td>6</td>
<td>train</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>192.208</td>
<td>6</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.008</td>
<td>54.140</td>
<td>7</td>
<td>train</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>0.009</td>
<td>224.684</td>
<td>7</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.050</td>
<td>46.042</td>
<td>8</td>
<td>train</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>275.958</td>
<td>8</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.045</td>
<td>32.179</td>
<td>9</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>286.695</td>
<td>9</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.098</td>
<td>35.831</td>
<td>10</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.009</td>
<td>300.782</td>
<td>10</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.142</td>
<td>26.238</td>
<td>11</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>311.709</td>
<td>11</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.245</td>
<td>28.274</td>
<td>12</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>323.532</td>
<td>12</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.157</td>
<td>26.449</td>
<td>13</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>325.302</td>
<td>13</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.183</td>
<td>19.315</td>
<td>14</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.023</td>
<td>301.128</td>
<td>14</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.450</td>
<td>14.059</td>
<td>15</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.023</td>
<td>289.292</td>
<td>15</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.394</td>
<td>15.945</td>
<td>16</td>
<td>train</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>0.091</td>
<td>272.089</td>
<td>16</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.491</td>
<td>10.472</td>
<td>17</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.091</td>
<td>253.606</td>
<td>17</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.450</td>
<td>19.727</td>
<td>18</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.091</td>
<td>250.489</td>
<td>18</td>
<td>eval</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>0.636</td>
<td>9.860</td>
<td>19</td>
<td>train</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>0.091</td>
<td>245.718</td>
<td>19</td>
<td>eval</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-80-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>With a small dataset of 8, batch size is very important factor. When batch size is 2, model gets updated frequently and results in different bounding boxes. However, if it is 4 to 8, it takes more epochs to get close bounding boxes.</p>
<p>The images shown are predi</p>
<div id="cell-116" class="cell" data-scrolled="false" data-execution_count="91">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>learn.model.<span class="bu">eval</span>()</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>):</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    x0, y0 <span class="op">=</span> trn_ds[i]</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     bboxes = cellboxes_to_boxes(learn.model(x0.unsqueeze(0).to(DEVICE)))[0]</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     bboxes = non_max_suppression(bboxes[0], iou_threshold=0.5, threshold=0.4, box_format='midpoint')</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     bboxes = [[[boxes[0]] + boxes[2:] for boxes in bboxes]][0]</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     show_image_with_boxes(x0, bboxes, figsize=(8,8))</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> learn.model(x0.unsqueeze(<span class="dv">0</span>).to(DEVICE))</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    show_image_with_boxes(x0, shape_bb(pred, conf_threshold<span class="op">=</span><span class="fl">0.4</span>), figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>), title<span class="op">=</span><span class="st">'Predictions'</span>)</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>    show_image_with_boxes(x0, shape_bb(y0, conf_threshold<span class="op">=</span><span class="fl">0.4</span>), figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>), title<span class="op">=</span><span class="st">'Targets'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-11.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-13.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-15.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-81-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Not too bad. Let’s save the model.</p>
<div id="cell-118" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_checkpoint(state, filename<span class="op">=</span><span class="st">"my_checkpoint.pth.tar"</span>):</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"=&gt; Saving checkpoint"</span>)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    torch.save(state, filename)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-119" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> {<span class="st">'state_dict'</span>: learn.model.state_dict(), <span class="st">'optimizer'</span>: learn.opt.state_dict()}</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>save_checkpoint(checkpoint, <span class="st">'8examples_1e-4_20.pth.tar'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=&gt; Saving checkpoint</code></pre>
</div>
</div>
<p>It’s almost 1 GB.</p>
<div id="cell-121" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls <span class="op">-</span>lh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>total 4.8G
-rw-r--r-- 1 kappa kappa  17M May 29 20:52 00_core.ipynb
-rw-r--r-- 1 kappa kappa 464K May 20 21:00 01_train.ipynb
-rw-r--r-- 1 kappa kappa 400K Mar 25 00:30 50_darknet.ipynb
-rw-r--r-- 1 kappa kappa 3.9M Mar 26 10:43 51_pascal.ipynb
-rw-r--r-- 1 kappa kappa 1.6M May 10 18:24 52_detection.ipynb
-rw-r--r-- 1 kappa kappa 1.5M May 27 16:24 53_yolov1.ipynb
-rw-r--r-- 1 kappa kappa 6.6M May 20 22:46 54_yolov1_miniai.ipynb
-rw-r--r-- 1 kappa kappa 7.1M May 14 11:10 55_yolov1_miniai_bac.ipynb
-rw-r--r-- 1 kappa kappa 982M May 29 20:51 8examples_1e-4_20.pth.tar
-rw-r--r-- 1 kappa kappa  330 Jan  2 08:13 _quarto.yml
-rw-r--r-- 1 kappa kappa 2.7K May 23 23:34 fasttransform.ipynb
-rw-r--r-- 1 kappa kappa 2.5K May 10 18:24 index.ipynb
-rw-r--r-- 1 kappa kappa  260 Mar 26 10:45 nbdev.yml
-rw-r--r-- 1 kappa kappa 709M May 20 22:33 overfit.pth.tar
-rw-r--r-- 1 kappa kappa  175 Mar 26 10:45 sidebar.yml
-rw-rw-r-- 1 kappa kappa  600 Sep  1  2024 styles.css
-rw-r--r-- 1 kappa kappa 3.1G May 14 11:42 yolov1_1e-6_20.pth.tar</code></pre>
</div>
</div>
<div id="cell-122" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_checkpoint(weight_path, model, optimizer):</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"=&gt; Loading checkpoint"</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    checkpoint <span class="op">=</span> torch.load(weight_path, weights_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    model.load_state_dict(checkpoint[<span class="st">"state_dict"</span>])</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    optimizer.load_state_dict(checkpoint[<span class="st">"optimizer"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-123" class="cell" data-execution_count="418">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>load_checkpoint(<span class="st">'8examples_1e-4_20.pth.tar'</span>, learn.model, learn.opt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=&gt; Loading checkpoint</code></pre>
</div>
</div>
</section>
<section id="bacteria-images" class="level2">
<h2 class="anchored" data-anchor-id="bacteria-images">Bacteria images</h2>
<p>Our model on VOC seems okay. Let’s finetune it on bacteria images.</p>
<div id="cell-126" class="cell" data-execution_count="419">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="419">
<pre><code>(#18) [Path('/home/kappa/data/pili/training_data/WT-A86C-LB-ice-002.png'),Path('/home/kappa/data/pili/training_data/200ms-0.4%-005.png'),Path('/home/kappa/data/pili/training_data/1hr01002.csv'),Path('/home/kappa/data/pili/training_data/dCpdA R1 FH 017.png'),Path('/home/kappa/data/pili/training_data/Chp B Replicate 2 200 MS060.png'),Path('/home/kappa/data/pili/training_data/4hrs incu004.csv'),Path('/home/kappa/data/pili/training_data/7.1- 003.png'),Path('/home/kappa/data/pili/training_data/4hrs incu004.png'),Path('/home/kappa/data/pili/training_data/200ms-0.4%-005.csv'),Path('/home/kappa/data/pili/training_data/WT-A86C-LB-ice-002.csv'),Path('/home/kappa/data/pili/training_data/0.1%.004.png'),Path('/home/kappa/data/pili/training_data/dCpdA R1 FH 017.csv'),Path('/home/kappa/data/pili/training_data/0N01002.csv'),Path('/home/kappa/data/pili/training_data/0N01002.png'),Path('/home/kappa/data/pili/training_data/Chp B Replicate 2 200 MS060.csv'),Path('/home/kappa/data/pili/training_data/7.1- 003.csv'),Path('/home/kappa/data/pili/training_data/1hr01002.png'),Path('/home/kappa/data/pili/training_data/0.1%.004.csv')]</code></pre>
</div>
</div>
<div id="cell-127" class="cell" data-execution_count="420">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>img_path <span class="op">=</span> path<span class="op">/</span><span class="st">'0N01002.png'</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>bac_im <span class="op">=</span> np.array(Image.<span class="bu">open</span>(img_path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-128" class="cell" data-execution_count="421">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>yolo_bac_boxes <span class="op">=</span> calc_yolo_boxes(path<span class="op">/</span><span class="st">'0N01002.csv'</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>yolo_bac_boxes[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="421">
<pre><code>tensor([[1.0000, 0.1250, 0.9701, 0.0279, 0.0272],
        [1.0000, 0.1804, 0.9871, 0.0306, 0.0237],
        [1.0000, 0.1521, 0.8542, 0.0264, 0.0271],
        [1.0000, 0.3414, 0.8812, 0.0201, 0.0277],
        [6.0000, 0.3072, 0.9942, 0.0144, 0.0109]], dtype=torch.float64)</code></pre>
</div>
</div>
<div id="cell-129" class="cell" data-execution_count="422">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>yolo_bac_boxes.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="422">
<pre><code>torch.Size([187, 5])</code></pre>
</div>
</div>
<div id="cell-130" class="cell" data-execution_count="423">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(bac_im, yolo_bac_boxes, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-91-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-131" class="cell" data-execution_count="424">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_bacteria_dataframe(path):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> <span class="bu">list</span>(path.glob(<span class="st">'*'</span>))</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    png_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> files <span class="cf">if</span> f.suffix <span class="op">==</span> <span class="st">'.png'</span>]</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    csv_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> files <span class="cf">if</span> f.suffix <span class="op">==</span> <span class="st">'.csv'</span>]</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    pairs <span class="op">=</span> []</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> png_file <span class="kw">in</span> png_files:</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>        stem <span class="op">=</span> png_file.stem</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>        matching_csv <span class="op">=</span> <span class="bu">next</span>((f <span class="cf">for</span> f <span class="kw">in</span> csv_files <span class="cf">if</span> f.stem <span class="op">==</span> stem), <span class="va">None</span>)</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> matching_csv: pairs.append([png_file.name, matching_csv.name])</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(pairs, columns<span class="op">=</span>[<span class="st">'img'</span>, <span class="st">'label'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-132" class="cell" data-execution_count="425">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>bac_df <span class="op">=</span> create_bacteria_dataframe(path)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>bac_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="425">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">img</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>WT-A86C-LB-ice-002.png</td>
<td>WT-A86C-LB-ice-002.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>200ms-0.4%-005.png</td>
<td>200ms-0.4%-005.csv</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>dCpdA R1 FH 017.png</td>
<td>dCpdA R1 FH 017.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Chp B Replicate 2 200 MS060.png</td>
<td>Chp B Replicate 2 200 MS060.csv</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7.1- 003.png</td>
<td>7.1- 003.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>4hrs incu004.png</td>
<td>4hrs incu004.csv</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.1%.004.png</td>
<td>0.1%.004.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0N01002.png</td>
<td>0N01002.csv</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1hr01002.png</td>
<td>1hr01002.csv</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-133" class="cell" data-execution_count="426">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>trn_bac_df, val_bac_df <span class="op">=</span> bac_df.iloc[<span class="dv">1</span>:<span class="dv">7</span>], bac_df.iloc[<span class="dv">7</span>:]</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>trn_bac_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="426">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">img</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>200ms-0.4%-005.png</td>
<td>200ms-0.4%-005.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>dCpdA R1 FH 017.png</td>
<td>dCpdA R1 FH 017.csv</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Chp B Replicate 2 200 MS060.png</td>
<td>Chp B Replicate 2 200 MS060.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>7.1- 003.png</td>
<td>7.1- 003.csv</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>4hrs incu004.png</td>
<td>4hrs incu004.csv</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>0.1%.004.png</td>
<td>0.1%.004.csv</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-134" class="cell" data-execution_count="427">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>path<span class="op">/</span>trn_bac_df.iloc[<span class="dv">0</span>, <span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="427">
<pre><code>Path('/home/kappa/data/pili/training_data/200ms-0.4%-005.png')</code></pre>
</div>
</div>
<div id="cell-135" class="cell" data-execution_count="428">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>trn_bac_df.to_csv(<span class="st">"../bac_train.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-136" class="cell" data-execution_count="429">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>val_bac_df.to_csv(<span class="st">'../bac_valid.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-137" class="cell" data-execution_count="430">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BacDataset(Dataset):</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, csv_file, img_dir, label_dir, S<span class="op">=</span><span class="dv">7</span>, B<span class="op">=</span><span class="dv">2</span>, C<span class="op">=</span><span class="dv">20</span>, transform<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.annotations, <span class="va">self</span>.img_dir <span class="op">=</span> pd.read_csv(csv_file), fc.Path(img_dir)</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_dir, <span class="va">self</span>.transform <span class="op">=</span> fc.Path(label_dir), transform</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.S, <span class="va">self</span>.B, <span class="va">self</span>.C <span class="op">=</span> S, B, C</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>): <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.annotations)</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, index):</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>        label_path <span class="op">=</span> <span class="va">self</span>.label_dir <span class="op">/</span> <span class="va">self</span>.annotations.iloc[index, <span class="dv">1</span>]</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="va">self</span>.img_dir <span class="op">/</span> <span class="va">self</span>.annotations.iloc[index, <span class="dv">0</span>]</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(img_path)</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> calc_yolo_boxes(label_path)</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform: image, boxes <span class="op">=</span> <span class="va">self</span>.transform(image, boxes)</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>        label_matrix <span class="op">=</span> torch.zeros((<span class="va">self</span>.S, <span class="va">self</span>.S, <span class="va">self</span>.C <span class="op">+</span> <span class="dv">5</span> <span class="op">*</span> <span class="va">self</span>.B))</span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> box <span class="kw">in</span> boxes:</span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>            class_label, x, y, width, height <span class="op">=</span> box</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>            class_label <span class="op">=</span> <span class="bu">int</span>(class_label)</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>            i, j <span class="op">=</span> <span class="bu">int</span>(<span class="va">self</span>.S <span class="op">*</span> y), <span class="bu">int</span>(<span class="va">self</span>.S <span class="op">*</span> x)</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>            x_cell, y_cell <span class="op">=</span> <span class="va">self</span>.S <span class="op">*</span> x <span class="op">-</span> j, <span class="va">self</span>.S <span class="op">*</span> y <span class="op">-</span> i</span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>            width_cell, height_cell <span class="op">=</span> width <span class="op">*</span> <span class="va">self</span>.S, height <span class="op">*</span> <span class="va">self</span>.S</span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="dv">0</span> <span class="op">&gt;</span> i <span class="kw">or</span> i <span class="op">&gt;=</span> <span class="dv">7</span> <span class="kw">or</span> <span class="dv">0</span> <span class="op">&gt;</span> j <span class="kw">or</span> j <span class="op">&gt;=</span> <span class="dv">7</span>: </span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(i,j)</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> label_matrix[i, j, <span class="dv">20</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>                label_matrix[i, j, <span class="dv">20</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>                label_matrix[i, j, <span class="dv">21</span>:<span class="dv">25</span>] <span class="op">=</span> torch.tensor([x_cell, y_cell, width_cell, height_cell])</span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>                label_matrix[i, j, class_label] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, label_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-138" class="cell" data-execution_count="431">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>bac_trn_ds <span class="op">=</span> BacDataset(<span class="st">"../bac_train.csv"</span>, path, path, C<span class="op">=</span><span class="dv">20</span>, transform<span class="op">=</span>transform)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># bac_trn_ds = BacDataset("../bac_train.csv", path, path, C=20)</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>x0, y0 <span class="op">=</span> bac_trn_ds[<span class="dv">5</span>]</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>x0.shape, y0.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="431">
<pre><code>(torch.Size([3, 448, 448]), torch.Size([7, 7, 30]))</code></pre>
</div>
</div>
<p>Many boxes are missing because only one class can be predicted from each cell.</p>
<div id="cell-140" class="cell" data-execution_count="432">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, shape_bb(y0))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-100-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-141" class="cell" data-execution_count="433">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>bac_val_ds <span class="op">=</span> BacDataset(<span class="st">'../bac_valid.csv'</span>, path, path, C<span class="op">=</span><span class="dv">20</span>, transform<span class="op">=</span>transform)</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>x0, y0 <span class="op">=</span> bac_val_ds[<span class="dv">0</span>]</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>x0.shape, y0.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="433">
<pre><code>(torch.Size([3, 448, 448]), torch.Size([7, 7, 30]))</code></pre>
</div>
</div>
<p>Hmm.</p>
<div id="cell-143" class="cell" data-execution_count="434">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>show_image_with_boxes(x0, shape_bb(y0))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-102-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-144" class="cell" data-execution_count="435">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>bac_trn_dl, bac_val_dl <span class="op">=</span> get_dls(bac_trn_ds, bac_val_ds, bs)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(bac_trn_dl))</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="435">
<pre><code>(torch.Size([2, 3, 448, 448]), torch.Size([2, 7, 7, 30]))</code></pre>
</div>
</div>
<div id="cell-145" class="cell" data-execution_count="436">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>bac_dls <span class="op">=</span> DataLoaders(bac_trn_dl, bac_val_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-146" class="cell" data-execution_count="437">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>lr, epochs <span class="op">=</span> <span class="fl">3e-3</span>, <span class="dv">25</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>tmax <span class="op">=</span> epochs <span class="op">*</span> <span class="bu">len</span>(bac_dls.train)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>sched <span class="op">=</span> partial(lr_scheduler.OneCycleLR, max_lr<span class="op">=</span>lr, total_steps<span class="op">=</span>tmax)</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>xtra <span class="op">=</span> [BatchSchedCB(sched)]</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a><span class="co"># learn = Learner(model, bac_dls, YoloLoss(), lr=lr, cbs=cbs+xtra, opt_func=torch.optim.AdamW)</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>learn.dls <span class="op">=</span> bac_dls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-147" class="cell" data-scrolled="true" data-execution_count="438">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>learn.show_image_batch(max_n<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-106-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-148" class="cell" data-scrolled="false" data-execution_count="439">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>learn.fit(epochs, cbs<span class="op">=</span>[ProgressCB(plot<span class="op">=</span><span class="va">True</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">MeanAP</th>
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.000</td>
<td>2110.353</td>
<td>0</td>
<td>train</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>2019.032</td>
<td>0</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>1616.481</td>
<td>1</td>
<td>train</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>1406.707</td>
<td>1</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>1043.905</td>
<td>2</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>748.545</td>
<td>2</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>711.525</td>
<td>3</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>580.770</td>
<td>3</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>626.063</td>
<td>4</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>551.427</td>
<td>4</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>529.337</td>
<td>5</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>572.216</td>
<td>5</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>559.300</td>
<td>6</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>489.061</td>
<td>6</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>622.305</td>
<td>7</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>460.538</td>
<td>7</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>513.237</td>
<td>8</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>416.242</td>
<td>8</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>434.381</td>
<td>9</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>395.815</td>
<td>9</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.001</td>
<td>407.428</td>
<td>10</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>357.732</td>
<td>10</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>317.297</td>
<td>11</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>333.096</td>
<td>11</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>250.294</td>
<td>12</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>310.736</td>
<td>12</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>224.237</td>
<td>13</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>283.839</td>
<td>13</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>226.868</td>
<td>14</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>267.242</td>
<td>14</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.001</td>
<td>193.923</td>
<td>15</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>259.993</td>
<td>15</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>172.583</td>
<td>16</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>263.563</td>
<td>16</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.004</td>
<td>183.626</td>
<td>17</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>259.507</td>
<td>17</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.000</td>
<td>178.855</td>
<td>18</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>253.352</td>
<td>18</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.006</td>
<td>151.948</td>
<td>19</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>250.560</td>
<td>19</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.005</td>
<td>146.231</td>
<td>20</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>249.883</td>
<td>20</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.004</td>
<td>153.878</td>
<td>21</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>247.891</td>
<td>21</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.005</td>
<td>138.734</td>
<td>22</td>
<td>train</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>247.245</td>
<td>22</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.004</td>
<td>147.657</td>
<td>23</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>245.872</td>
<td>23</td>
<td>eval</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>0.006</td>
<td>135.498</td>
<td>24</td>
<td>train</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>0.000</td>
<td>245.713</td>
<td>24</td>
<td>eval</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-107-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0
7 0</code></pre>
</div>
</div>
<div id="cell-149" class="cell" data-execution_count="440">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>learn.model.<span class="bu">eval</span>()</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>):</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    x0, y0 <span class="op">=</span> bac_trn_ds[i]</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> learn.model(x0.unsqueeze(<span class="dv">0</span>).to(DEVICE))</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>    show_image_with_boxes(x0, shape_bb(pred, conf_threshold<span class="op">=</span><span class="fl">0.4</span>), figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>), title<span class="op">=</span><span class="st">'Predictions'</span>)</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>    show_image_with_boxes(x0, shape_bb(y0, conf_threshold<span class="op">=</span><span class="fl">0.4</span>), figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>), title<span class="op">=</span><span class="st">'Targets'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-108-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-108-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="image-transform" class="level2">
<h2 class="anchored" data-anchor-id="image-transform">Image transform</h2>
<section id="clahe" class="level3">
<h3 class="anchored" data-anchor-id="clahe">CLAHE</h3>
<p>Tackling low signal problem: Let’s take a look at an image with labels.</p>
<p>How CLAHE (Contrast Limited Adaptive Histogram Equalization) works:</p>
<ol type="1">
<li>Basic Principle:</li>
</ol>
<ul>
<li>Unlike regular histogram equalization which works on the entire image at once, CLAHE works on small regions (tiles) of the image</li>
<li>This local approach helps maintain local details and contrast</li>
</ul>
<ol start="2" type="1">
<li>Step-by-Step Process:
<ul>
<li>The image is divided into small tiles (defined by tile_grid_size)</li>
<li>For each tile:
<ul>
<li>A local histogram is computed</li>
<li>The histogram is clipped at a predetermined value (clip_limit) to prevent noise amplification</li>
<li>Histogram equalization is applied to that tile</li>
</ul></li>
<li>Bilinear interpolation is used to eliminate artificial boundaries between tiles</li>
</ul></li>
<li>Key Advantages:
<ul>
<li>Better handling of local contrast</li>
<li>Prevents over-amplification of noise (through clipping)</li>
<li>Preserves edges and local details</li>
<li>Works well with varying brightness levels in different image regions</li>
</ul></li>
<li>Parameters Impact:
<ul>
<li>clip_limit: Higher values allow more contrast enhancement but may increase noise</li>
<li>tile_grid_size: Smaller tiles give more local enhancement but might make the image look “patchy”</li>
</ul></li>
</ol>
<div id="cell-154" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>im.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(1952, 1952)</code></pre>
</div>
</div>
<p>TODO: Why are we using <code>uint16</code>? Maybe should change it to float32 or bfloat16?</p>
<div id="cell-156" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>im.dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>dtype('uint16')</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/core.py#L95" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="apply_clahe" class="level3">
<h3 class="anchored" data-anchor-id="apply_clahe">apply_clahe</h3>
<blockquote class="blockquote">
<pre><code> apply_clahe (image, clip_limit=2.0, tile_grid_size=(8, 8))</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/core.py#L103" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="compare_ims" class="level3">
<h3 class="anchored" data-anchor-id="compare_ims">compare_ims</h3>
<blockquote class="blockquote">
<pre><code> compare_ims (img1, img2, im1_title='img1', im2_title='img2', cmap='gray')</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/galopyz/pilus_project/blob/main/pilus_project/core.py#L118" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="compare_ims_with_boxes" class="level3">
<h3 class="anchored" data-anchor-id="compare_ims_with_boxes">compare_ims_with_boxes</h3>
<blockquote class="blockquote">
<pre><code> compare_ims_with_boxes (img1, img2, boxes1=None, boxes2=None,
                         im1_title='img1', im2_title='img2', legend=None,
                         legend_loc='best', bformat=None, **kwargs)</code></pre>
</blockquote>
<div id="cell-160" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>enh <span class="op">=</span> apply_clahe(im, clip_limit<span class="op">=</span><span class="fl">10.1</span>, tile_grid_size<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>compare_ims_with_boxes(im, enh)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-114-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s what it looks like with labels:</p>
<div id="cell-162" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>compare_ims_with_boxes(im, enh, boxes2<span class="op">=</span>y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-115-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/galopyz\.github\.io\/pilus_project");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/galopyz/pilus_project/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>